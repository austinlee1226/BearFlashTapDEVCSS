<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel JD - Bear Flash Tap Master</title>

    <style>
        /* --- åŸºç¤ç’°å¢ƒè¨­å®š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; font-family: sans-serif; }
        
        #game-container { 
            width: 720px; height: 1280px; 
            position: relative; overflow: hidden; 
            background: #1a1a2e; 
            transform-origin: center; flex-shrink: 0; 
            touch-action: none; 
        }
        
        .ui-element { position: absolute; transform: translate(-50%, -50%); transform-origin: center; user-select: none; -webkit-user-drag: none; }

        /* --- 1. èƒŒæ™¯èˆ‡è§’è‰² --- */
        #bg-main { width: 720px; height: 1280px; left: 360px; top: 640px; z-index: 0; }
        
        /* èƒŒæ™¯é–ƒé›» VFX */
        .vfx-thunder { width: 244px; height: 234px; z-index: 1; pointer-events: none; opacity: 1; }
        #vfx-thunder-left { left: 11px; top: 291px; transform: translate(-50%, -50%) scaleX(-1); animation: thunder-flicker-off 5s infinite; }
        #vfx-thunder-right { left: 711px; top: 293px; transform: translate(-50%, -50%); animation: thunder-flicker-off 7s infinite 2s; }

        @keyframes thunder-flicker-off {
            0%, 92% { opacity: 1; } 93% { opacity: 0; } 94% { opacity: 1; } 95% { opacity: 0.3; } 96% { opacity: 1; } 100% { opacity: 1; }
        }

        /* è§’è‰²è¨­å®š */
        #ui-character-bear, #ui-character-devil { width: 496px; height: 612px; left: 360px; top: 460px; z-index: 2; transition: filter 0.1s; }
        #ui-character-devil { display: none; }

        /* è§’è‰²å‹•ç•« */
        @keyframes anim-shake {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-51%, -50%) rotate(-1deg); } 
            50% { transform: translate(-49%, -50%) rotate(1deg); }  
            75% { transform: translate(-50.5%, -50%) rotate(-0.5deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        .effect-shake { animation: anim-shake 0.15s ease-in-out; }

        @keyframes anim-sink {
            0% { transform: translate(-50%, -50%); opacity: 1; filter: grayscale(0); }
            20% { transform: translate(-50%, -50%); opacity: 1; filter: grayscale(1); }
            100% { transform: translate(-50%, -20%); opacity: 0; filter: grayscale(1); }
        }
        .effect-sink { animation: anim-sink 1.0s ease-in forwards; }

        @keyframes anim-rise {
            0% { transform: translate(-50%, -20%); opacity: 0; }
            100% { transform: translate(-50%, -50%); opacity: 1; }
        }
        .effect-rise { display: block !important; animation: anim-rise 0.8s ease-out forwards; }

        #ui-panel-main { width: 720px; height: 810px; left: 360px; top: 875px; z-index: 5; }
        
        /* --- 2. â³ è¨ˆæ™‚å™¨å®¹å™¨ --- */
        #ui-timer-container {
            position: absolute; left: 360px; top: 98px; width: 300px; height: 80px;
            transform: translate(-50%, -50%) scale(1.2); z-index: 30;
            display: flex; justify-content: center; align-items: center; gap: 0; pointer-events: none;
        }
        .timer-digit { height: 100%; width: 50px; object-fit: contain; margin: 0 -3px; }
        .timer-colon-slot { height: 60%; width: 30px; object-fit: contain; margin-top: -5px; }

        /* --- 3. éŠæˆ²æ ¸å¿ƒ UI --- */
        #ui-text-combo-time { width: 189px; height: 32px; left: 129px; top: 501px; z-index: 20; }
        #ui-combo-bar-bg { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 20; }
        #ui-combo-bar-fill { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 21; transform-origin: left; transform: translate(-50%, -50%) scaleX(1); transition: transform 0.3s ease-out; cursor: pointer; }
        #ui-combo-bar-cover { width: 25px; height: 26px; left: 237px; top: 501px; z-index: 22; pointer-events: none; }
        
        #ui-game-score {
            position: absolute; left: 402px; width: 300px; top: 100px; transform: translateY(-50%);
            display: flex; justify-content: flex-end; align-items: center; z-index: 30; pointer-events: none; gap: 1px;
        }
        .score-digit-img { height: 20px; width: auto; object-fit: contain; }

        /* HIT ç‰¹æ•ˆå®¹å™¨ */
        .hit-effect-wrapper {
            position: absolute; display: flex; flex-direction: row; align-items: center; justify-content: center;
            gap: 5px; pointer-events: none; 
            z-index: 999; /* æœ€ä¸Šå±¤ */
            transform: translate(-50%, -50%);
            animation: hit-float 1.5s cubic-bezier(0.1, 0.8, 0.2, 1) forwards;
        }
        .hit-num-digit { height: 40px; width: auto; object-fit: contain; margin: 0 -10px; }
        .hit-text-img { width: 74px; height: 38px; object-fit: contain; margin-left: 5px; }

        @keyframes hit-float {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            10% { transform: translate(-50%, -150%) scale(1.3); opacity: 1; } 
            100% { transform: translate(-50%, -450%) scale(1.0); opacity: 0; } 
        }

        /* ä¹å®®æ ¼æŒ‰éˆ• */
        #game-grid { position: absolute; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .card-slot { 
            position: absolute; width: 230px; height: 230px; transform: translate(-50%, -50%); 
            pointer-events: auto; cursor: pointer; transition: transform 0.08s cubic-bezier(0.1, 0.7, 1.0, 0.1); touch-action: manipulation; 
        }
        .card-slot.pressed { transform: translate(-50%, -50%) scale(0.92) !important; filter: brightness(0.9); }
        .btn-card-base { width: 100%; height: 100%; display: block; }
        
        /* ã€ä¿®æ­£ç¢ºèªã€‘é€™è£¡ç¾åœ¨æ˜¯å®Œå…¨çš„åŸåœ–å°ºå¯¸ */
        .num-wrapper { 
            position: absolute; left: 50%; top: 50%; 
            transform: translate(-50%, -50%); 
            display: flex; justify-content: center; align-items: center; 
            pointer-events: none; width: 100%; 
        }
        .num-wrapper img { 
            height: auto;  /* ä¿®æ­£ï¼šè‡ªå‹•é«˜åº¦ */
            width: auto;   /* ä¿®æ­£ï¼šè‡ªå‹•å¯¬åº¦ */
            object-fit: contain;
            margin: 0;     
            flex-shrink: 0;
        }

        /* æ˜Ÿæ˜Ÿç²’å­ç‰¹æ•ˆ */
        .particle-star { 
            position: absolute; width: 44px; height: 44px; pointer-events: none; 
            z-index: 999; /* æœ€ä¸Šå±¤ */
            transform-origin: center; transition: transform 0.8s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.8s ease-in; opacity: 1; 
        }

        .hud-item { z-index: 15; transition: opacity 0.2s; }
        #ui-heart-1 { width: 44px; height: 38px; left: 53px; top: 100px; }
        #ui-heart-2 { width: 44px; height: 38px; left: 101px; top: 100px; }
        #ui-heart-3 { width: 44px; height: 38px; left: 149px; top: 100px; }
        #ui-icon-star { width: 44px; height: 44px; left: 528px; top: 99px; z-index: 15; }

        .countdown-img { z-index: 50; display: none; pointer-events: none; }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; }
        }
        .anim-pop { animation: popIn 0.5s ease-out forwards; }
        
        /* å€’æ•¸ 321 æ–‡å­— */
        #ui-text-3 { width: 167px; height: 211px; left: 358px; top: 757px; }
        #ui-text-2 { width: 169px; height: 211px; left: 356px; top: 757px; }
        #ui-text-1 { width: 101px; height: 212px; left: 355px; top: 757px; }
        #ui-text-go { width: 343px; height: 185px; left: 357px; top: 757px; }

        /* éŠæˆ²çµæŸç‹€æ…‹æ–‡å­— */
        .end-text { z-index: 100; display: none; pointer-events: none; }
        .anim-pop-end { animation: popIn 0.5s ease-out forwards; display: block !important; }
        #ui-text-gameover { width: 396px; height: 217px; left: 350px; top: 770px; } 
        #ui-text-timeup { width: 385px; height: 215px; left: 363px; top: 770px; }   

        /* --- 5. é¦–é åœ–å±¤ --- */
        #ui-home-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 100; }
        #ui-mask { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.5); cursor: pointer; }
        #ui-panel-start { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 101; }
        #character-home { width: 547px; height: 496px; left: 361px; top: 676px; z-index: 102; }
        #logo-main { width: 514px; height: 216px; left: 369px; top: 315px; z-index: 102; }
        
        #btn-coffee, #btn-share, #btn-start { z-index: 103; cursor: pointer; transition: transform 0.1s; touch-action: manipulation; }
        #btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; }
        #btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; }
        #btn-start { width: 522px; height: 101px; left: 360px; top: 981px; }
        
        .btn-pressed { transform: translate(-50%, -50%) scale(0.95) !important; filter: brightness(0.9); }
        #ui-text-start { width: 364px; height: 56px; left: 362px; top: 985px; z-index: 104; pointer-events: none; transition: transform 0.1s; }
        #btn-start.pressed ~ #ui-text-start { transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9); }

        /* --- è¼¸å…¥ä»‹é¢ --- */
        #ui-input-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 180; display: none; }
        #ui-panel-input { width: 540px; height: 240px; left: 360px; top: 600px; z-index: 181; }
        #ui-input-field {
            position: absolute; left: 362px; top: 640px; transform: translate(-50%, -50%);
            width: 320px; height: 60px; z-index: 182;
            background: transparent; border: none; outline: none;
            color: #fff; font-size: 36px; font-weight: 900; text-align: center;
            font-family: monospace; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        #ui-input-field::placeholder { color: rgba(255,255,255,0.3); }
        #btn-confirm-name { width: 522px; height: 101px; left: 360px; top: 800px; z-index: 182; cursor: pointer; }

        /* --- 6. ğŸ† çµç®—ä»‹é¢ --- */
        #ui-result-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 200; display: none; }
        #res-panel { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 201; }
        #res-panel-rank { width: 547px; height: 653px; left: 361px; top: 598px; z-index: 202; }
        #logo-rank-title { width: 378px; height: 162px; left: 360px; top: 184px; z-index: 205; }

        #rank-content-layer {
            position: absolute; left: 361px; top: 598px; width: 540px; height: 600px; 
            border-radius: 30px; overflow: hidden; transform: translate(-50%, -50%); z-index: 203;
        }
        #rank-scroll-view {
            width: 100%; height: 100%; overflow-y: scroll; -webkit-overflow-scrolling: touch;
            scrollbar-width: none; -ms-overflow-style: none; 
            display: flex; flex-direction: column; align-items: center;
            padding-top: 10px; padding-bottom: 120px; 
        }
        #rank-scroll-view::-webkit-scrollbar { display: none; }

        .rank-row {
            width: 522px; height: 101px; margin-bottom: -2px; 
            background-image: url('assets/ui_rank_row_normal.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            flex-shrink: 0; position: relative; 
            font-weight: 900; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        .rank-num { position: absolute; left: 20px; width: 82px; top: 50%; transform: translateY(-50%); text-align: left; color: rgb(255, 222, 0); font-size: 40px; font-style: normal; white-space: nowrap; }
        .rank-name { position: absolute; left: 106px; width: 152px; top: 50%; transform: translateY(-50%); text-align: left; color: rgb(255, 255, 255); font-size: 28px; white-space: nowrap; overflow: hidden; }
        .rank-flag { position: absolute; left: 260px; top: 50%; transform: translateY(-50%); font-size: 28px; font-style: normal; text-shadow: none; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5)); z-index: 2; }
        .rank-score { position: absolute; left: 258px; width: 240px; top: 50%; transform: translateY(-50%); display: flex; justify-content: flex-end; align-items: center; gap: -2px; }
        .rank-score-digit { height: 28px; width: auto; object-fit: contain; }

        #rank-fixed-row {
            position: absolute; left: 360px; top: 855px; width: 522px; height: 101px;
            transform: translate(-50%, -50%); z-index: 205; 
            background-image: url('assets/ui_rank_row_self.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            font-weight: 900; pointer-events: none;
        }

        #res-btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; z-index: 203; cursor: pointer; }
        #res-btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; z-index: 203; cursor: pointer; }
        #res-btn-retry { width: 522px; height: 101px; left: 360px; top: 981px; z-index: 203; cursor: pointer; }
        #ui-text-retry { width: 323px; height: 55px; left: 362px; top: 985px; z-index: 204; pointer-events: none; transition: transform 0.1s; }
        #res-btn-retry.pressed ~ #ui-text-retry { transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9); }

        #bg-bar-top { width: 720px; height: 53px; left: 360px; top: 27px; z-index: 20; }
        #bg-bar-bottom { width: 720px; height: 69px; left: 360px; top: 1246px; z-index: 20; }

        #debug-panel { position: fixed; top: 10px; right: 10px; z-index: 999; background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; width: 210px; font-family: monospace; }
        .debug-group { margin-bottom: 12px; border-bottom: 1px solid #444; padding-bottom: 8px; }
        .debug-group label { display: block; font-size: 11px; color: #ffeb3b; margin-bottom: 5px; }
        .debug-btn { background: #444; color: #fff; border: 1px solid #666; padding: 4px; margin: 2px; cursor: pointer; border-radius: 4px; font-size: 10px; width: 45%; }
 /* --- éŒ¯èª¤åé¥‹ç‰¹æ•ˆ (å»ºè­°è²¼åœ¨ç¬¬240è¡Œä¹‹å‰) --- */

/* å®šç¾©éœ‡å‹•å‹•ç•« */
@keyframes cardShake {
    0%, 100% { transform: translate(-50%, -50%) translateX(0); }
    25% { transform: translate(-50%, -50%) translateX(-8px); }
    75% { transform: translate(-50%, -50%) translateX(8px); }
}

/* å®šç¾©éŒ¯èª¤ç‹€æ…‹ class */
.wrong-flash-card {
    /* 1. å…ˆæŠŠé£½å’Œåº¦é™åˆ° 0 (è®Šç°éš)ï¼Œé€™æ˜¯è®“é¡è‰²è®Šæ·¡è®Šç™½çš„æœ€ç©©åšæ³• */
    /* 2. æ¥è‘—æŠŠäº®åº¦æ‹‰é«˜åˆ° 1.5 ~ 1.8 ä¹‹é–“ (æ·¡ç™½è‰²) */
    /* 3. ç¨å¾®å¢åŠ å°æ¯”åº¦ï¼Œè®“åœ–ç‰‡è¼ªå»“ä¸æ¶ˆå¤± */
    filter: grayscale(1) brightness(1.7) contrast(1.1) !important;
    
    /* ç¢ºä¿åœ–ç‰‡æœ¬èº«å®Œå…¨ä¸é€æ˜ */
    opacity: 1 !important; 
    
    /* ç¶­æŒéœ‡å‹•å‹•ç•« */
    animation: cardShake 0.2s linear;
}
/* è¨ˆæ™‚å™¨è­¦ç¤ºï¼šæ¿¾é¡è®Šç´… */
.timer-danger {
    filter: sepia(1) saturate(10) hue-rotate(-50deg) !important;
}

/* å®šç¾©è·³å‹•å‹•ç•« */
@keyframes timerPulse {
    0% { transform: translate(-50%, -50%) scale(1.2); }
    50% { transform: translate(-50%, -50%) scale(1.4); }
    100% { transform: translate(-50%, -50%) scale(1.2); }
}

/* åŠ ä¸Šé€™å€‹ Class å°±æœƒé–‹å§‹è·³å‹• */
.timer-pulse {
    animation: timerPulse 0.5s infinite;
}
 </style>
</head>
<body>

<div id="game-container">
    <img src="assets/bg_main.webp" class="ui-element" id="bg-main">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-left">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-right">
    
    <img src="assets/character_bear.webp" class="ui-element" id="ui-character-bear">
    <img src="assets/character_bear_devil.webp" class="ui-element" id="ui-character-devil">

    <img src="assets/panel_main.webp" class="ui-element" id="ui-panel-main">

    <div id="ui-timer-container">
        <img id="timer-d1" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d2" class="timer-digit" src="assets/num_ui_1.webp">
        <img class="timer-colon-slot" src="assets/num_ui_colon.webp">
        <img id="timer-d3" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d4" class="timer-digit" src="assets/num_ui_0.webp">
    </div>

    <audio id="bgm-main" src="assets/bgm_main.mp3" loop preload="auto"></audio>

    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-1">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-2">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-3">
    <img src="assets/icon_star.webp" class="ui-element" id="ui-icon-star">
    
    <div id="ui-game-score"></div>

    <img src="assets/ui_text_combo_time.webp" class="ui-element" id="ui-text-combo-time">
    <img src="assets/ui_combo_bar_bg.webp" class="ui-element" id="ui-combo-bar-bg">
    <img src="assets/ui_combo_bar_fill.webp" class="ui-element" id="ui-combo-bar-fill">
    <img src="assets/ui_combo_bar_cover.webp" class="ui-element" id="ui-combo-bar-cover">

    <div id="game-grid">
        <div class="card-slot" style="left: 130px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_1.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_2.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_3.webp"></div></div>
        <div class="card-slot" style="left: 130px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_4.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_5.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_6.webp"></div></div>
        <div class="card-slot" style="left: 130px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_7.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_8.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_9.webp"></div></div>
    </div>

    <img src="assets/ui_text_3.webp" class="ui-element countdown-img" id="ui-text-3">
    <img src="assets/ui_text_2.webp" class="ui-element countdown-img" id="ui-text-2">
    <img src="assets/ui_text_1.webp" class="ui-element countdown-img" id="ui-text-1">
    <img src="assets/ui_text_go.webp" class="ui-element countdown-img" id="ui-text-go">

    <img src="assets/ui_text_gameover.webp" class="ui-element end-text" id="ui-text-gameover">
    <img src="assets/ui_text_timeup.webp" class="ui-element end-text" id="ui-text-timeup">

    <div id="ui-home-screen">
        <div id="ui-mask" onclick="this.parentElement.style.display='none'"></div>
        <img src="assets/ui_panel_start.webp" class="ui-element" id="ui-panel-start">
        <img src="assets/character_home.webp" class="ui-element" id="character-home">
        <img src="assets/logo_main.webp" class="ui-element" id="logo-main">
        <img src="assets/btn_coffee.webp" class="ui-element" id="btn-coffee" onclick="alert('Support Button!')">
        <img src="assets/btn_share.webp" class="ui-element" id="btn-share" onclick="alert('Share Button!')">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-start" onclick="startGameProcess()">
        <img src="assets/ui_text_start.webp" class="ui-element" id="ui-text-start">
    </div>

    <div id="ui-input-screen">
        <div style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);"></div>
        <img src="assets/ui_panel_input_name.webp" class="ui-element" id="ui-panel-input">
        <input type="text" id="ui-input-field" placeholder="INPUT NAME" maxlength="8">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-confirm-name" onclick="submitName()">
    </div>

    <div id="ui-result-screen">
        <div id="ui-mask-result" style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);" onclick="this.parentElement.style.display='none'"></div>
        <img src="assets/logo_rank_title.webp" class="ui-element" id="logo-rank-title">
        <img src="assets/ui_panel_start.webp" class="ui-element" id="res-panel">
        <img src="assets/ui_panel_rank.webp" class="ui-element" id="res-panel-rank"> 
        <div id="rank-content-layer">
            <div id="rank-scroll-view"></div>
        </div>
        <div id="rank-fixed-row">
            <span class="rank-num">6</span>
            <span class="rank-name" id="my-rank-name">YOU</span>
            <span class="rank-flag">ğŸ‡¹ğŸ‡¼</span>
            <div class="rank-score" id="my-rank-score-container"></div>
        </div>
        <img src="assets/btn_coffee.webp" class="ui-element" id="res-btn-coffee">
        <img src="assets/btn_share.webp" class="ui-element" id="res-btn-share">
        <img src="assets/btn_start.webp" class="ui-element" id="res-btn-retry" onclick="startGameProcess()">
        <img src="assets/ui_text_retry.webp" class="ui-element" id="ui-text-retry">
    </div>

    <img src="assets/bg_bar_top.webp" class="ui-element" id="bg-bar-top">
    <img src="assets/bg_bar_bottom.webp" class="ui-element" id="bg-bar-bottom">
</div>

<div id="debug-panel">
    <div class="debug-group">
        <label>ç•«é¢æ¸¬è©¦</label>
        <button class="debug-btn" onclick="showInputScreen()" style="background:#2196f3; border-color:#64b5f6;">âŒ¨ æ¸¬è©¦è¼¸å…¥ä»‹é¢</button>
        <button class="debug-btn" onclick="showResultScreen()" style="background:#f57c00; border-color:#ffb74d;">ğŸ’€ é¡¯ç¤ºçµç®—ä»‹é¢</button>
        <button class="debug-btn" onclick="triggerBearDeath()" style="background:#d32f2f; border-color:#ef5350;">ğŸ» æ¸¬è©¦è®Šèº«</button>
    </div>
    <div class="debug-group">
        <label>éŠæˆ²æµç¨‹</label>
        <button class="debug-btn btn-play" onclick="startGameProcess()">â–¶ æ¸¬è©¦å€’æ•¸</button>
        <button class="debug-btn" onclick="stopGameTimer()">â¹ åœæ­¢è¨ˆæ™‚</button>
    </div>
    <div class="debug-group">
        <label>æ•¸å­—ç¸®æ”¾</label>
        <button class="debug-btn" onclick="testDigits(2)">2ä½</button>
        <button class="debug-btn" onclick="testDigits(5)">5ä½</button>
    </div>
    <div class="debug-group">
        <label>HP / Bar æ¸¬è©¦</label>
        <button class="debug-btn" onclick="testHP(1)">1 HP</button>
        <button class="debug-btn" onclick="testHP(3)">å…¨æ»¿</button>
        <input type="range" id="debug-slider" min="0" max="100" value="100" oninput="testBar(this.value)" style="width:95%; margin-top:5px;">
    </div>
    <button class="debug-btn" style="width:100%; background:#c62828;" onclick="this.parentElement.style.display='none'">éš±è—é¢æ¿</button>
</div>

<script>
    // --- ç¬¬ä¸€æ­¥é©Ÿï¼šåœ¨æ­¤è™•è²¼ä¸Šå…¨åŸŸéŸ³æ•ˆå·¥å…· ---
    let audioCtx = null; // éŸ³æ•ˆç’°å¢ƒè®Šæ•¸

    // æ ¸å¿ƒéŸ³æ•ˆå‡½å¼ f:é »ç‡(Hz), t:æ³¢å½¢é¡å‹, d:æŒçºŒæ™‚é–“(ç§’)
  function playSnd(f, t, d) {
    // å¦‚æœéŸ³æ•ˆç’°å¢ƒä¸å­˜åœ¨æˆ–æœªå•Ÿå‹•ï¼Œå°±ç›´æ¥è·³å‡ºï¼Œé¿å…ç¨‹å¼å ±éŒ¯
       if (!audioCtx || audioCtx.state !== 'running') return;
    
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = t; 
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.4, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d); // è‡ªå‹•æ·¡å‡º
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }
    // ------------------------------------
    let gameTimer = null;
    let timeLeft = 1000;
    let comboCount = 0;
    let currentScore = 0;
    let playerName = "YOU"; 
    let lastInputTime = 0;
    const INPUT_COOLDOWN = 60; 
// --- æ–°å¢ï¼šé€£æ“Šèˆ‡åˆ†æ•¸æ ¸å¿ƒè®Šæ•¸ ---
    let lastHitTime = 0;      // ç´€éŒ„ä¸Šä¸€æ¬¡æ­£ç¢ºé»æ“Šçš„çµ•å°æ™‚é–“
    let comboTimerReq = null; // ç”¨æ–¼æ§åˆ¶é€£æ“Šæ¢å‹•ç•«

    // æ ¸å¿ƒï¼šé€£æ“Šç´šè·å¾—åˆ†è¨ˆç®— (ä¾ç…§ä½ æä¾›çš„ç´šè·è¡¨)
    function calculateStepScore(combo) {
    const baseScore = 10; // åŸºç¤åˆ†ç¶­æŒ 10
    let bonus = 0;
    let multiplier = 1;

    if (combo === 0) {
        bonus = 0;
    } else if (combo <= 100) {
        // åŸæœ¬æ˜¯ 1 + ... æ”¹æˆ 10 + ...
        bonus = 10 + Math.floor(combo / 10) * 10; 
    } else if (combo <= 300) {
        // åŸæœ¬åŸºæ•¸ 22 æ”¹æˆ 220ï¼Œå¾Œæ–¹åŠ æˆä¹Ÿ * 10
        bonus = 220 + Math.floor((combo - 100) / 50) * 20;
    } else if (combo <= 600) {
        // åŸæœ¬åŸºæ•¸ 35 æ”¹æˆ 350
        bonus = 350 + Math.floor((combo - 300) / 100) * 50;
    } else if (combo <= 1000) {
        bonus = 600 + Math.floor((combo - 600) / 200) * 100;
    } else if (combo <= 2000) {
        bonus = 1000 + Math.floor((combo - 1000) / 250) * 200;
    } else if (combo <= 3000) {
        bonus = 2300 + Math.floor((combo - 2000) / 500) * 500;
    } else if (combo <= 4000) {
        bonus = 4300 + Math.floor((combo - 3000) / 500) * 1000;
    } else if (combo <= 5000) {
        bonus = 8300 + Math.floor((combo - 4000) / 500) * 2000;
    } else {
        // 5000+ æ¥µé™æ¨¡å¼ï¼šåŸæœ¬ 2060 æ”¹æˆ 20600
        bonus = 20600; 
        multiplier = 2; 
    }
    
    // æœ€çµ‚è¨ˆç®—ï¼š(10 + 20600) * 2 = 41220 åˆ†ï¼
    return (baseScore + bonus) * multiplier;
}

    // æ ¸å¿ƒï¼šå–å¾—ç•¶å‰ Combo å°æ‡‰çš„çª—å£æ™‚é–“ (ms)
    function getComboWindow(combo) {
        if (combo <= 100) return 1000;
        if (combo <= 300) return 800;
        if (combo <= 600) return 500;
        return 300; // 601+ ä»¥ä¸Šåªæœ‰ 0.3 ç§’
    }

// --- è²¼åœ¨é€™è£¡ï¼šå¯¦æ™‚å€’é€€é€£æ“Šæ¢é‚è¼¯ ---
    function updateComboBar() {
        if (!state.isPlaying || comboCount === 0) {
            document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(0)`;
            return;
        }

        const now = Date.now();
        const windowTime = getComboWindow(comboCount);
        const elapsed = now - lastHitTime;
        let remainRatio = (windowTime - elapsed) / windowTime;

        if (remainRatio <= 0) {
            remainRatio = 0;
            // é€™è£¡è®“æ¢å­åœåœ¨ 0ï¼Œå¯¦è³ªçš„ combo é‡ç½®äº¤çµ¦ handleCardTap åˆ¤å®š
        }

        // æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ transform ä»£æ›¿ width
        document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(${remainRatio})`;

        if (state.isPlaying && remainRatio > 0) {
            comboTimerReq = requestAnimationFrame(updateComboBar);
        }
    }
    // ---------------------------------

    // éŠæˆ²ç‹€æ…‹
    let state = {
        isPlaying: false,
        isPaused: false,
        hearts: 3,
        round: 1,
        currentTarget: 1,
        maxTargetInWave: 9,
        numbersOnGrid: []
    };

    const timerEls = {
        d1: document.getElementById('timer-d1'),
        d2: document.getElementById('timer-d2'),
        d3: document.getElementById('timer-d3'),
        d4: document.getElementById('timer-d4')
    };

    function resizeGame() {
        const container = document.getElementById('game-container');
        const scale = Math.min(window.innerWidth / 720, window.innerHeight / 1280);
        container.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame);
    window.addEventListener('load', () => {
        resizeGame();
        preloadGameAssets();
        // ç¶å®šæŒ‰éµç‰¹æ•ˆèˆ‡æ›æ•¸å­—é‚è¼¯ (ä½†ç¾åœ¨æ•¸å­—ç”±éŠæˆ²é‚è¼¯æ§åˆ¶)
        document.querySelectorAll('.card-slot').forEach((slot, i) => {
            setupButtonFeedback(slot, true, i); 
        });
        updateScoreDisplay(0); 
        initLeaderboard(); 
        
        document.getElementById('ui-input-field').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') submitName();
        });
    });

    function preloadGameAssets() {
        const assets = [
            'num_ui_0.webp', 'num_ui_1.webp', 'num_ui_2.webp', 'num_ui_3.webp', 'num_ui_4.webp',
            'num_ui_5.webp', 'num_ui_6.webp', 'num_ui_7.webp', 'num_ui_8.webp', 'num_ui_9.webp', 'num_ui_colon.webp',
            'num_grid_0.webp', 'num_grid_1.webp', 'num_grid_2.webp', 'num_grid_3.webp', 'num_grid_4.webp',
            'num_grid_5.webp', 'num_grid_6.webp', 'num_grid_7.webp', 'num_grid_8.webp', 'num_grid_9.webp',
            'ui_rank_row_normal.webp', 'ui_rank_row_self.webp', 'logo_rank_title.webp',
            'icon_star.webp', 'vfx_thunder.webp', 'ui_text_hit.webp', 'character_bear_devil.webp',
            'ui_panel_input_name.webp', 'ui_text_gameover.webp', 'ui_text_timeup.webp'
        ];
        assets.forEach(name => {
            const img = new Image();
            img.src = 'assets/' + name;
        });
    }

    function resetGameUI() {
        const bear = document.getElementById('ui-character-bear');
        const devil = document.getElementById('ui-character-devil');
        bear.style.display = 'block';
        bear.classList.remove('effect-sink', 'effect-shake');
        devil.style.display = 'none';
        devil.classList.remove('effect-rise');
        
        // ç¢ºä¿é‡æ–°é–‹å§‹æ™‚æ„›å¿ƒæ˜¯æ»¿çš„
        testHP(3); 
        
        // éš±è—æ‰€æœ‰çµæŸç›¸é—œçš„æ–‡å­—èˆ‡ä»‹é¢
        document.getElementById('ui-text-gameover').classList.remove('anim-pop-end');
        document.getElementById('ui-text-timeup').classList.remove('anim-pop-end');
        
        // éš±è—æ‰€æœ‰åœ–å±¤ï¼Œç¢ºä¿ç›´æ¥é€²å…¥å€’æ•¸ç•«é¢
        document.getElementById('ui-home-screen').style.display = 'none';
        document.getElementById('ui-result-screen').style.display = 'none'; 
        document.getElementById('ui-input-screen').style.display = 'none';
        
        // åˆ†æ•¸èˆ‡è¨ˆæ™‚å™¨ç«‹åˆ»æ­¸é›¶
        updateScoreDisplay(0);
        updateTimerDisplay(1000);
        
        // --- å¼·åˆ¶å¤§æƒé™¤ï¼šæ¸…ç©ºä¹å®®æ ¼æ•¸å­—ä¸¦æ¢å¾©é€æ˜åº¦ï¼Œé˜²æ­¢ä¸Šä¸€å ´æ®˜å½± ---
        document.querySelectorAll('.card-slot').forEach(slot => {
            slot.style.opacity = '1'; 
            const wrapper = slot.querySelector('.num-wrapper');
            if (wrapper) wrapper.innerHTML = ''; 
        });
    }

    function startGameProcess() {
    // --- ä¿®æ­£å¾Œçš„éŸ³æ•ˆç’°å¢ƒåˆå§‹åŒ– ---
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    // iOS é—œéµï¼šå¦‚æœéŸ³æ•ˆç’°å¢ƒè¢«æ›èµ·ï¼Œå¿…é ˆæ‰‹å‹•æ¢å¾©
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    // ----------------------------

    // æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ (ä½¿ç”¨æ›´ç©©å®šçš„ Promise å¯«æ³•)
    const bgm = document.getElementById('bgm-main');
    if (bgm) {
        bgm.volume = 0.5;
        bgm.play().catch(e => console.log("æ‰‹æ©ŸéŸ³æ¨‚æ’¥æ”¾å—é™:", e));
    }
        resetGameUI();
        state = {
            isPlaying: false,
            isPaused: false,
            hearts: 3,
            round: 1,
            currentTarget: 1,
            maxTargetInWave: 9,
            numbersOnGrid: []
        };
        currentScore = 0;
        
        const ids = ['ui-text-3', 'ui-text-2', 'ui-text-1', 'ui-text-go'];
        let delay = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.style.display = 'none';
            el.classList.remove('anim-pop');
        });
        ids.forEach((id, index) => {
            setTimeout(() => {
                if(index > 0) document.getElementById(ids[index-1]).style.display = 'none';
                const el = document.getElementById(id);
                el.style.display = 'block';
                el.classList.add('anim-pop');
                if (id === 'ui-text-go') {
                    setTimeout(() => { 
                        el.style.display = 'none'; 
                        startGameLoop(); 
                    }, 500);
                }
            }, delay);
            delay += 800;
        });
    }

    function startGameLoop() {
        state.isPlaying = true;
        timeLeft = 1000;
        comboCount = 0;
        updateScoreDisplay(0);
        updateTimerDisplay(timeLeft);
        spawnWave();
        
        // --- ä¿®æ­£é»ï¼šåˆå§‹åŒ–ç¬¬ä¸€æ¬¡é»æ“Šçš„åƒè€ƒæ™‚é–“ ---
        lastHitTime = Date.now(); 
        // -----------------------------------

        if (gameTimer) clearInterval(gameTimer);
        gameTimer = setInterval(() => {
            if (!state.isPlaying || state.isPaused) return;
            timeLeft--;
            if (timeLeft <= 0) {
                timeLeft = 0;
                gameOver('time');
            }
            updateTimerDisplay(timeLeft);
        }, 10);
    }

    function spawnWave() {
        const startNum = state.round;
        state.currentTarget = startNum;
        state.maxTargetInWave = startNum + 8;
        
        let nums = [];
        for(let i=0; i<9; i++) nums.push(startNum + i);
        // æ´—ç‰Œ
        for (let i = nums.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [nums[i], nums[j]] = [nums[j], nums[i]];
        }
        state.numbersOnGrid = nums;

        const slots = document.querySelectorAll('.card-slot');
        slots.forEach((slot, i) => {
            slot.style.display = 'block';
            slot.style.opacity = '1';
            setGridNumber(i, nums[i]);
        });
    }

 function handleCardTap(index) {
        if (!state.isPlaying || state.isPaused) return;

        const clickedNum = state.numbersOnGrid[index];
        const slot = document.querySelectorAll('.card-slot')[index];

        // é˜²æ­¢é‡è¤‡é»æ“Šå·²ç¶“éš±è—çš„å¡ç‰‡
        if (slot.style.opacity === '0') return;

        if (clickedNum === state.currentTarget) {
            const now = Date.now();
            const windowTime = getComboWindow(comboCount);

            // --- 1. é€£æ“Šåˆ¤å®šé‚è¼¯ ---
            if (comboCount > 0 && (now - lastHitTime) > windowTime) {
                comboCount = 1; // é»å°ä½†è¶…æ™‚ï¼Œé‡ç½®é€£æ“Š
            } else {
                comboCount++;   // é»å°ä¸”æº–æ™‚ï¼Œé€£æ“Šå¢åŠ 
            }
            lastHitTime = now;

            // --- 2. å…¨å‹•æ…‹åˆ†æ•¸è¨ˆç®— ---
            const scoreThisHit = calculateStepScore(comboCount);
            currentScore += scoreThisHit;
            updateScoreDisplay(currentScore);

            // --- 3. è¦–è¦ºèˆ‡éŸ³æ•ˆå›é¥‹ ---
            const cx = parseInt(slot.style.left);
            const cy = parseInt(slot.style.top);
            createStarBurst(cx, cy);
            createHitEffect(cx, cy, comboCount);
            
            const freq = 800 + (Math.min(comboCount, 200) * 5);
            playSnd(freq, 'sine', 0.1);

            timeLeft += 50; // æ™‚é–“çå‹µ +0.5s
            slot.style.opacity = '0';
            state.currentTarget++;

            // --- 4. å•Ÿå‹•é€£æ“Šæ¢å€’é€€å‹•ç•« ---
            cancelAnimationFrame(comboTimerReq);
            updateComboBar();

            // --- 5. åˆ¤å®šéé—œèˆ‡å›è¡€é‚è¼¯ ---
            if (state.currentTarget > state.maxTargetInWave) {
                if (state.round % 5 === 0 && state.hearts < 3) {
                    state.hearts++;
                    testHP(state.hearts);
                    playSnd(1200, 'sine', 0.3);
                    createHealEffect();
                }
                state.round++;
                setTimeout(spawnWave, 200);
            }
        } else {
            // --- 6. é»éŒ¯æ‡²ç½°é‚è¼¯ ---
            state.hearts--;
            timeLeft -= 100; // æ™‚é–“æ‡²ç½° -1.0s
            comboCount = 0;
            lastHitTime = 0;
            
            playSnd(150, 'sawtooth', 0.2);
            testHP(state.hearts);
            handleBearHit();

            slot.classList.add('wrong-flash-card');
            setTimeout(() => slot.classList.remove('wrong-flash-card'), 200);

            if (state.hearts <= 0) {
                gameOver('hearts');
            }
        }
    }

    function gameOver(reason) {
       // åœæ­¢èƒŒæ™¯éŸ³æ¨‚ä¸¦é‡è¨­é€²åº¦
    const bgm = document.getElementById('bgm-main');
        if (bgm) {
        bgm.pause();
        bgm.currentTime = 0; 
    }
        state.isPlaying = false;
        stopGameTimer();
        triggerBearDeath();
        
        setTimeout(() => {
            if (reason === 'time') {
                document.getElementById('ui-text-timeup').classList.add('anim-pop-end');
            } else {
                document.getElementById('ui-text-gameover').classList.add('anim-pop-end');
            }
        }, 800);

        setTimeout(() => {
            showInputScreen();
        }, 2800); 
    }

    function setGridNumber(index, number) {
        const slots = document.querySelectorAll('.card-slot');
        if (!slots[index]) return;
        const wrapper = slots[index].querySelector('.num-wrapper');
        const numStr = number.toString();
        
        wrapper.innerHTML = '';
        
        for (let char of numStr) {
            const img = document.createElement('img');
            img.src = `assets/num_grid_${char}.webp`;
            wrapper.appendChild(img);
        }

        // [å®‰å…¨æ©Ÿåˆ¶]
        let scaleValue = 1.0;
        if (numStr.length >= 4) {
            scaleValue = 0.6; 
        }
        wrapper.style.transform = `translate(-50%, -50%) scale(${scaleValue})`;
    }

    function createStarBurst(x, y) {
        const container = document.getElementById('game-container');
        for (let i = 0; i < 5; i++) {
            const star = document.createElement('img');
            star.src = 'assets/icon_star.webp';
            star.className = 'particle-star';
            const size = Math.random() * 40 + 60; 
            star.style.width = `${size}px`; star.style.height = `${size}px`;
            star.style.left = `${x}px`; star.style.top = `${y}px`;
            star.style.transform = `translate(-50%, -50%) scale(0.5)`;
            const angle = Math.random() * Math.PI * 2; 
            const velocity = Math.random() * 150 + 100; 
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;
            const rot = Math.random() * 720; 
            container.appendChild(star);
            requestAnimationFrame(() => {
                star.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(0) rotate(${rot}deg)`;
                star.style.opacity = '0';
            });
            setTimeout(() => star.remove(), 800);
        }
    }
    // --- è£œä¸Šé€™å€‹åŠŸèƒ½å®šç¾©ï¼Œç‰¹æ•ˆæ‰æœƒè·‘å‡ºä¾† ---
    function createHealEffect() {
        const container = document.getElementById('game-container');
        const heart = document.createElement('img');
        heart.src = 'assets/icon_heart.webp';
        heart.style.position = 'absolute';
        heart.style.width = '60px';
        heart.style.height = 'auto';
        heart.style.zIndex = '999';
        heart.style.left = '360px'; // ç•«é¢ä¸­å¿ƒ
        heart.style.top = '460px';  // ç†Šç†Šä½ç½®
        heart.style.transform = 'translate(-50%, -50%) scale(0.5)';
        heart.style.transition = 'transform 1s ease-out, opacity 1s ease-out, top 1s ease-out';
        container.appendChild(heart);

        requestAnimationFrame(() => {
            heart.style.top = '260px';
            heart.style.transform = 'translate(-50%, -50%) scale(1.5)';
            heart.style.opacity = '0';
        });
        setTimeout(() => heart.remove(), 1000);
    }
    function createHitEffect(x, y, comboVal) {
        const container = document.getElementById('game-container');
        const wrapper = document.createElement('div');
        wrapper.className = 'hit-effect-wrapper';
        wrapper.style.left = `${x}px`;
        wrapper.style.top = `${y - 50}px`; 
        const valStr = comboVal.toString();
        for (let char of valStr) {
            const digit = document.createElement('img');
            digit.src = `assets/num_ui_${char}.webp`;
            digit.className = 'hit-num-digit';
            wrapper.appendChild(digit);
        }
        const hitImg = document.createElement('img');
        hitImg.src = 'assets/ui_text_hit.webp';
        hitImg.className = 'hit-text-img';
        wrapper.appendChild(hitImg);
        container.appendChild(wrapper);
        setTimeout(() => wrapper.remove(), 1500); 
    }

    function updateScoreDisplay(newScore) {
        const scoreContainer = document.getElementById('ui-game-score');
        scoreContainer.innerHTML = ''; 
        const scoreStr = newScore.toString().padStart(8, '0');
        for (let char of scoreStr) {
            const img = document.createElement('img');
            img.src = `assets/num_grid_${char}.webp`;
            img.className = 'score-digit-img';
            scoreContainer.appendChild(img);
        }
    }

    function getScoreHtml(score) {
        const str = score.toString().padStart(8, '0');
        let html = '';
        for(let char of str) {
            html += `<img src="assets/num_grid_${char}.webp" class="rank-score-digit">`;
        }
        return html;
    }

    function initLeaderboard() {
        const list = document.getElementById('rank-scroll-view');
        if(!list) return;
        list.innerHTML = ''; 
        const flags = ['ğŸ‡¹ğŸ‡¼', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡°ğŸ‡·', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡«ğŸ‡·', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡¹ğŸ‡­'];
        for(let i=1; i<=100; i++) {
            const row = document.createElement('div');
            row.className = 'rank-row';
            const rankStr = i;
            let nameRaw = `Player${i}`;
            const nameStr = nameRaw.substring(0, 8); 
            let scoreRaw = 99999 - i * 100;
            const flagEmoji = flags[i % flags.length];
            let rankFontSize = '40px'; 
            if (i >= 1000) rankFontSize = '32px'; 
            if (i >= 10000) rankFontSize = '26px'; 
            row.innerHTML = `
                <span class="rank-num" style="font-size:${rankFontSize}">${rankStr}</span>
                <span class="rank-name">${nameStr}</span>
                <span class="rank-flag">${flagEmoji}</span>
                <div class="rank-score">${getScoreHtml(scoreRaw)}</div>
            `;
            list.appendChild(row);
        }
        const myScoreContainer = document.getElementById('my-rank-score-container');
        if(myScoreContainer) {
            myScoreContainer.innerHTML = getScoreHtml(12345);
        }
    }

    function handleBearHit() {
        const bearNormal = document.getElementById('ui-character-bear');
        const bearDevil = document.getElementById('ui-character-devil');
        const activeBear = (bearDevil.style.display !== 'none' && bearDevil.classList.contains('effect-rise')) ? bearDevil : bearNormal;
        activeBear.classList.remove('effect-shake');
        void activeBear.offsetWidth; 
        activeBear.classList.add('effect-shake');
        setTimeout(() => {
            activeBear.classList.remove('effect-shake');
        }, 200);
    }

    function triggerBearDeath() {
        const bearNormal = document.getElementById('ui-character-bear');
        const bearDevil = document.getElementById('ui-character-devil');
        bearNormal.classList.add('effect-sink');
        setTimeout(() => {
            bearNormal.style.display = 'none'; 
            bearDevil.style.display = 'block'; 
            bearDevil.classList.add('effect-rise');
        }, 1000); 
    }

    function setupButtonFeedback(element, isCard = false, index = -1) {
        if (!element) return;
        const pressClass = isCard ? 'pressed' : 'btn-pressed';
        element.addEventListener('pointerdown', (e) => {
            const now = Date.now();
            if (now - lastInputTime < INPUT_COOLDOWN) return; 
            lastInputTime = now;
            element.classList.add(pressClass);
            element.setPointerCapture(e.pointerId);
            if (isCard && state.isPlaying) {
                handleCardTap(index);
            }
        });
        const release = () => { element.classList.remove(pressClass); };
        element.addEventListener('pointerup', release);
        element.addEventListener('pointerleave', release);
        element.addEventListener('pointercancel', release);
    }
    
    // Bind buttons
    setupButtonFeedback(document.getElementById('btn-start'));
    setupButtonFeedback(document.getElementById('btn-coffee'));
    setupButtonFeedback(document.getElementById('btn-share'));
    setupButtonFeedback(document.getElementById('res-btn-retry'));
    setupButtonFeedback(document.getElementById('res-btn-coffee'));
    setupButtonFeedback(document.getElementById('res-btn-share'));
    setupButtonFeedback(document.getElementById('btn-confirm-name'));

    function showInputScreen() {
        document.getElementById('ui-home-screen').style.display = 'none';
        document.getElementById('ui-result-screen').style.display = 'none';
        document.getElementById('ui-input-screen').style.display = 'block';
        document.getElementById('ui-input-field').focus();
    }

    function submitName() {
        const inputVal = document.getElementById('ui-input-field').value.trim();
        if (inputVal) {
            playerName = inputVal.substring(0, 8); 
        }
        document.getElementById('ui-input-screen').style.display = 'none';
        showResultScreen();
    }

    function showResultScreen() {
        document.getElementById('ui-result-screen').style.display = 'block';
        
        const nameEl = document.getElementById('my-rank-name');
        if(nameEl) nameEl.textContent = playerName;

        const myScoreContainer = document.getElementById('my-rank-score-container');
        if(myScoreContainer) {
            myScoreContainer.innerHTML = getScoreHtml(currentScore);
        }
    }

    function updateTimerDisplay(totalUnits) {
   // --- æ–°å¢é€™æ®µï¼šä½æ–¼ 3 ç§’è®Šç´…è·³å‹• ---
    const container = document.getElementById('ui-timer-container');
    if (totalUnits <= 300) {
        container.classList.add('timer-danger', 'timer-pulse');
    } else {
        container.classList.remove('timer-danger', 'timer-pulse');
    }
    // ---------------------------------
        const seconds = Math.floor(totalUnits / 100);
        const millis = totalUnits % 100;
        const sStr = seconds.toString().padStart(2, '0');
        const mStr = millis.toString().padStart(2, '0');
        if (timerEls.d1.src.indexOf(`num_ui_${sStr[0]}.webp`) === -1) timerEls.d1.src = `assets/num_ui_${sStr[0]}.webp`;
        if (timerEls.d2.src.indexOf(`num_ui_${sStr[1]}.webp`) === -1) timerEls.d2.src = `assets/num_ui_${sStr[1]}.webp`;
        if (timerEls.d3.src.indexOf(`num_ui_${mStr[0]}.webp`) === -1) timerEls.d3.src = `assets/num_ui_${mStr[0]}.webp`;
        if (timerEls.d4.src.indexOf(`num_ui_${mStr[1]}.webp`) === -1) timerEls.d4.src = `assets/num_ui_${mStr[1]}.webp`;
    }

    function stopGameTimer() {
        if (gameTimer) clearInterval(gameTimer);
    }

    function testDigits(d) {
        const val = Math.pow(10, d) - 1;
        document.querySelectorAll('.card-slot').forEach((_, i) => setGridNumber(i, val));
    }

    function testHP(hp) {
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`ui-heart-${i}`).style.opacity = i <= hp ? "1" : "0.2";
        }
    }

    function testBar(val) {
        document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(${val/100})`;
    }
    const fillBar = document.getElementById('ui-combo-bar-fill');
    fillBar.addEventListener('click', () => { fillBar.style.transform = `translate(-50%, -50%) scaleX(${Math.random()})`; });

    updateTimerDisplay(1000);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel JD - Bear Flash Tap Master</title>
    <style>
        /* --- Âü∫Á§éÁí∞Â¢ÉË®≠ÂÆö --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; font-family: sans-serif; }
        
        #game-container { 
            width: 720px; height: 1280px; 
            position: relative; overflow: hidden; 
            background: #1a1a2e; 
            transform-origin: center; flex-shrink: 0; 
            touch-action: none; 
        }
        
        .ui-element { position: absolute; transform: translate(-50%, -50%); transform-origin: center; user-select: none; -webkit-user-drag: none; }

        /* --- 1. ËÉåÊôØËàáËßíËâ≤ --- */
        #bg-main { width: 720px; height: 1280px; left: 360px; top: 640px; z-index: 0; }
        
        .vfx-thunder { width: 244px; height: 234px; z-index: 1; pointer-events: none; opacity: 1; }
        #vfx-thunder-left { left: 11px; top: 291px; transform: translate(-50%, -50%) scaleX(-1); animation: thunder-flicker-off 5s infinite; }
        #vfx-thunder-right { left: 711px; top: 293px; transform: translate(-50%, -50%); animation: thunder-flicker-off 7s infinite 2s; }

        @keyframes thunder-flicker-off {
            0%, 92% { opacity: 1; } 93% { opacity: 0; } 94% { opacity: 1; } 95% { opacity: 0.3; } 96% { opacity: 1; } 100% { opacity: 1; }
        }

        #ui-character-bear, #ui-character-devil { width: 496px; height: 612px; left: 360px; top: 460px; z-index: 2; transition: filter 0.1s; }
        #ui-character-devil { display: none; }

        @keyframes anim-shake {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-51%, -50%) rotate(-1deg); } 
            50% { transform: translate(-49%, -50%) rotate(1deg); }  
            75% { transform: translate(-50.5%, -50%) rotate(-0.5deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        .effect-shake { animation: anim-shake 0.15s ease-in-out; } 

        @keyframes anim-sink {
            0% { transform: translate(-50%, -50%); opacity: 1; filter: grayscale(0); }
            20% { transform: translate(-50%, -50%); opacity: 1; filter: grayscale(1); }
            100% { transform: translate(-50%, 0%); opacity: 0; filter: grayscale(1); } 
        }
        .effect-sink { animation: anim-sink 1.2s ease-in forwards; }

        @keyframes anim-rise {
            0% { transform: translate(-50%, 0%); opacity: 0; } 
            100% { transform: translate(-50%, -50%); opacity: 1; }
        }
        .effect-rise { display: block !important; animation: anim-rise 0.8s ease-out forwards; }

        #ui-panel-main { width: 720px; height: 810px; left: 360px; top: 875px; z-index: 5; }
        
        /* --- 2. ‚è≥ Ë®àÊôÇÂô®ÂÆπÂô® --- */
        #ui-timer-container {
            position: absolute; left: 360px; top: 98px; width: 300px; height: 80px;
            transform: translate(-50%, -50%) scale(1.2); z-index: 30;
            display: flex; justify-content: center; align-items: center; gap: 0; pointer-events: none;
        }
        @keyframes timer-panic {
            0% { transform: translate(-50%, -50%) scale(1.2); filter: none; }
            50% { transform: translate(-50%, -50%) scale(1.3); filter: sepia(1) hue-rotate(-50deg) saturate(3); } 
            100% { transform: translate(-50%, -50%) scale(1.2); filter: none; }
        }
        .timer-panic-mode { animation: timer-panic 0.5s infinite; }

        .timer-digit { height: 100%; width: 50px; object-fit: contain; margin: 0 -3px; }
        .timer-colon-slot { height: 60%; width: 30px; object-fit: contain; margin-top: -5px; }

        /* --- 3. ÈÅäÊà≤Ê†∏ÂøÉ UI --- */
        #ui-text-combo-time { width: 189px; height: 32px; left: 129px; top: 501px; z-index: 20; }
        #ui-combo-bar-bg { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 20; }
        #ui-combo-bar-fill { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 21; transform-origin: left; transform: translate(-50%, -50%) scaleX(1); transition: transform 0.1s linear; }
        #ui-combo-bar-cover { width: 25px; height: 26px; left: 237px; top: 501px; z-index: 22; pointer-events: none; }
        
        #ui-game-score {
            position: absolute; left: 402px; width: 300px; top: 100px; transform: translateY(-50%);
            display: flex; justify-content: flex-end; align-items: center; z-index: 30; pointer-events: none; gap: 1px;
        }
        .score-digit-img { height: 20px; width: auto; object-fit: contain; }

        /* HIT ÁâπÊïà */
        .hit-effect-wrapper {
            position: absolute; display: flex; flex-direction: row; align-items: center; justify-content: center;
            gap: 5px; pointer-events: none; z-index: 999; transform: translate(-50%, -50%);
            animation: hit-float 1.5s cubic-bezier(0.1, 0.8, 0.2, 1) forwards;
        }
        .hit-num-digit { height: 40px; width: auto; object-fit: contain; margin: 0 -10px; }
        .hit-text-img { width: 74px; height: 38px; object-fit: contain; margin-left: 5px; }

        @keyframes hit-float {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            10% { transform: translate(-50%, -150%) scale(1.3); opacity: 1; } 
            100% { transform: translate(-50%, -450%) scale(1.0); opacity: 0; } 
        }

        /* ‰πùÂÆÆÊ†ºÊåâÈàï */
        #game-grid { position: absolute; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .card-slot { 
            position: absolute; width: 230px; height: 230px; transform: translate(-50%, -50%); 
            pointer-events: auto; cursor: pointer; transition: transform 0.08s cubic-bezier(0.1, 0.7, 1.0, 0.1), opacity 0.1s; touch-action: manipulation; 
            display: none; 
        }
        .card-slot.pressed { transform: translate(-50%, -50%) scale(0.92) !important; filter: brightness(0.9); }
        .btn-card-base { width: 100%; height: 100%; display: block; }
        .num-wrapper { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; gap: -10px; pointer-events: none; width: 100%; }
        .num-wrapper img { width: 121px; height: 134px; flex-shrink: 0; }

        /* ÊòüÊòüÁ≤íÂ≠ê */
        .particle-star { position: absolute; width: 44px; height: 44px; pointer-events: none; z-index: 999; transform-origin: center; transition: transform 0.8s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.8s ease-in; opacity: 1; }

        .hud-item { z-index: 15; transition: opacity 0.2s; }
        #ui-heart-1 { width: 44px; height: 38px; left: 53px; top: 100px; }
        #ui-heart-2 { width: 44px; height: 38px; left: 101px; top: 100px; }
        #ui-heart-3 { width: 44px; height: 38px; left: 149px; top: 100px; }
        #ui-icon-star { width: 44px; height: 44px; left: 528px; top: 99px; z-index: 15; }

        .countdown-img { z-index: 50; display: none; pointer-events: none; }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; }
        }
        .anim-pop { animation: popIn 0.5s ease-out forwards; }
        #ui-text-3 { width: 167px; height: 211px; left: 358px; top: 757px; }
        #ui-text-2 { width: 169px; height: 211px; left: 356px; top: 757px; }
        #ui-text-1 { width: 101px; height: 212px; left: 355px; top: 757px; }
        #ui-text-go { width: 343px; height: 185px; left: 357px; top: 757px; }

        #ui-home-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 100; }
        #ui-mask { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.5); cursor: pointer; }
        #ui-panel-start { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 101; }
        #character-home { width: 547px; height: 496px; left: 361px; top: 676px; z-index: 102; }
        #logo-main { width: 514px; height: 216px; left: 369px; top: 315px; z-index: 102; }
        
        #btn-coffee, #btn-share, #btn-start { z-index: 103; cursor: pointer; transition: transform 0.1s; touch-action: manipulation; }
        #btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; }
        #btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; }
        #btn-start { width: 522px; height: 101px; left: 360px; top: 981px; }
        
        .btn-pressed { transform: translate(-50%, -50%) scale(0.95) !important; filter: brightness(0.9); }
        #ui-text-start { width: 364px; height: 56px; left: 362px; top: 985px; z-index: 104; pointer-events: none; transition: transform 0.1s; }
        #btn-start.pressed ~ #ui-text-start { transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9); }

        #ui-input-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 180; display: none; }
        #ui-panel-input { width: 540px; height: 240px; left: 360px; top: 600px; z-index: 181; }
        #ui-input-field {
            position: absolute; left: 362px; top: 640px; transform: translate(-50%, -50%);
            width: 320px; height: 60px; z-index: 182;
            background: transparent; border: none; outline: none;
            color: #fff; font-size: 36px; font-weight: 900; text-align: center;
            font-family: monospace; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        #ui-input-field::placeholder { color: rgba(255,255,255,0.3); }
        #btn-confirm-name { width: 522px; height: 101px; left: 360px; top: 800px; z-index: 182; cursor: pointer; }

        #ui-result-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 200; display: none; }
        #res-panel { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 201; }
        #res-panel-rank { width: 547px; height: 653px; left: 361px; top: 598px; z-index: 202; }
        #logo-rank-title { width: 378px; height: 162px; left: 360px; top: 184px; z-index: 205; }

        #rank-content-layer {
            position: absolute; left: 361px; top: 598px; width: 540px; height: 600px; 
            border-radius: 30px; overflow: hidden; transform: translate(-50%, -50%); z-index: 203;
        }
        #rank-scroll-view {
            width: 100%; height: 100%; overflow-y: scroll; -webkit-overflow-scrolling: touch;
            scrollbar-width: none; -ms-overflow-style: none; 
            display: flex; flex-direction: column; align-items: center;
            padding-top: 10px; padding-bottom: 120px; 
        }
        #rank-scroll-view::-webkit-scrollbar { display: none; }

        .rank-row {
            width: 522px; height: 101px; margin-bottom: -2px; 
            background-image: url('assets/ui_rank_row_normal.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            flex-shrink: 0; position: relative; 
            font-weight: 900; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        .rank-num { position: absolute; left: 20px; width: 82px; top: 50%; transform: translateY(-50%); text-align: left; color: rgb(255, 222, 0); font-size: 40px; font-style: normal; white-space: nowrap; }
        .rank-name { position: absolute; left: 106px; width: 152px; top: 50%; transform: translateY(-50%); text-align: left; color: rgb(255, 255, 255); font-size: 28px; white-space: nowrap; overflow: hidden; }
        .rank-flag { position: absolute; left: 260px; top: 50%; transform: translateY(-50%); font-size: 28px; font-style: normal; text-shadow: none; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5)); z-index: 2; }
        .rank-score { position: absolute; left: 258px; width: 240px; top: 50%; transform: translateY(-50%); display: flex; justify-content: flex-end; align-items: center; gap: -2px; }
        .rank-score-digit { height: 28px; width: auto; object-fit: contain; }

        #rank-fixed-row {
            position: absolute; left: 360px; top: 855px; width: 522px; height: 101px;
            transform: translate(-50%, -50%); z-index: 205; 
            background-image: url('assets/ui_rank_row_self.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            font-weight: 900; pointer-events: none;
        }

        #res-btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; z-index: 203; cursor: pointer; }
        #res-btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; z-index: 203; cursor: pointer; }
        #res-btn-retry { width: 522px; height: 101px; left: 360px; top: 981px; z-index: 203; cursor: pointer; }
        #ui-text-retry { width: 323px; height: 55px; left: 362px; top: 985px; z-index: 204; pointer-events: none; transition: transform 0.1s; }
        #res-btn-retry.pressed ~ #ui-text-retry { transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9); }

        #bg-bar-top { width: 720px; height: 53px; left: 360px; top: 27px; z-index: 20; }
        #bg-bar-bottom { width: 720px; height: 69px; left: 360px; top: 1246px; z-index: 20; }

        #debug-panel { position: fixed; top: 10px; right: 10px; z-index: 999; background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; width: 210px; font-family: monospace; }
        .debug-group { margin-bottom: 12px; border-bottom: 1px solid #444; padding-bottom: 8px; }
        .debug-group label { display: block; font-size: 11px; color: #ffeb3b; margin-bottom: 5px; }
        .debug-btn { background: #444; color: #fff; border: 1px solid #666; padding: 4px; margin: 2px; cursor: pointer; border-radius: 4px; font-size: 10px; width: 45%; }
    </style>
</head>
<body>

<div id="game-container">
    <img src="assets/bg_main.webp" class="ui-element" id="bg-main">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-left">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-right">
    
    <img src="assets/character_bear.webp" class="ui-element" id="ui-character-bear">
    <img src="assets/character_bear_devil.webp" class="ui-element" id="ui-character-devil">

    <img src="assets/panel_main.webp" class="ui-element" id="ui-panel-main">

    <div id="ui-timer-container">
        <img id="timer-d1" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d2" class="timer-digit" src="assets/num_ui_6.webp">
        <img class="timer-colon-slot" src="assets/num_ui_colon.webp">
        <img id="timer-d3" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d4" class="timer-digit" src="assets/num_ui_0.webp">
    </div>

    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-1">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-2">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-3">
    <img src="assets/icon_star.webp" class="ui-element" id="ui-icon-star">
    
    <div id="ui-game-score"></div>

    <img src="assets/ui_text_combo_time.webp" class="ui-element" id="ui-text-combo-time">
    <img src="assets/ui_combo_bar_bg.webp" class="ui-element" id="ui-combo-bar-bg">
    <img src="assets/ui_combo_bar_fill.webp" class="ui-element" id="ui-combo-bar-fill">
    <img src="assets/ui_combo_bar_cover.webp" class="ui-element" id="ui-combo-bar-cover">

    <div id="game-grid">
        <div class="card-slot" id="slot-0" style="left: 130px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-1" style="left: 360px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-2" style="left: 590px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-3" style="left: 130px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-4" style="left: 360px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-5" style="left: 590px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-6" style="left: 130px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-7" style="left: 360px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-8" style="left: 590px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
    </div>

    <img src="assets/ui_text_3.webp" class="ui-element countdown-img" id="ui-text-3">
    <img src="assets/ui_text_2.webp" class="ui-element countdown-img" id="ui-text-2">
    <img src="assets/ui_text_1.webp" class="ui-element countdown-img" id="ui-text-1">
    <img src="assets/ui_text_go.webp" class="ui-element countdown-img" id="ui-text-go">

    <div id="ui-home-screen">
        <div id="ui-mask" onclick="this.parentElement.style.display='none'"></div>
        <img src="assets/ui_panel_start.webp" class="ui-element" id="ui-panel-start">
        <img src="assets/character_home.webp" class="ui-element" id="character-home">
        <img src="assets/logo_main.webp" class="ui-element" id="logo-main">
        <img src="assets/btn_coffee.webp" class="ui-element" id="btn-coffee" onclick="alert('Support Button!')">
        <img src="assets/btn_share.webp" class="ui-element" id="btn-share" onclick="alert('Share Button!')">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-start" onclick="startGameProcess()">
        <img src="assets/ui_text_start.webp" class="ui-element" id="ui-text-start">
    </div>

    <div id="ui-input-screen">
        <div style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);"></div>
        <img src="assets/ui_panel_input_name.webp" class="ui-element" id="ui-panel-input">
        <input type="text" id="ui-input-field" placeholder="INPUT NAME" maxlength="8">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-confirm-name" onclick="submitName()">
    </div>

    <div id="ui-result-screen">
        <div id="ui-mask-result" style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);" onclick="this.parentElement.style.display='none'"></div>
        <img src="assets/logo_rank_title.webp" class="ui-element" id="logo-rank-title">
        <img src="assets/ui_panel_start.webp" class="ui-element" id="res-panel">
        <img src="assets/ui_panel_rank.webp" class="ui-element" id="res-panel-rank"> 
        <div id="rank-content-layer">
            <div id="rank-scroll-view"></div>
        </div>
        <div id="rank-fixed-row">
            <span class="rank-num">6</span>
            <span class="rank-name" id="my-rank-name">YOU</span>
            <span class="rank-flag">üáπüáº</span>
            <div class="rank-score" id="my-rank-score-container"></div>
        </div>
        <img src="assets/btn_coffee.webp" class="ui-element" id="res-btn-coffee">
        <img src="assets/btn_share.webp" class="ui-element" id="res-btn-share">
        <img src="assets/btn_start.webp" class="ui-element" id="res-btn-retry" onclick="restartGame()">
        <img src="assets/ui_text_retry.webp" class="ui-element" id="ui-text-retry">
    </div>

    <img src="assets/bg_bar_top.webp" class="ui-element" id="bg-bar-top">
    <img src="assets/bg_bar_bottom.webp" class="ui-element" id="bg-bar-bottom">
</div>

<div id="debug-panel">
    <div class="debug-group">
        <label>Áï´Èù¢Ê∏¨Ë©¶</label>
        <button class="debug-btn" onclick="showInputScreen()" style="background:#2196f3; border-color:#64b5f6;">‚å® Ê∏¨Ë©¶Ëº∏ÂÖ•‰ªãÈù¢</button>
        <button class="debug-btn" onclick="showResultScreen()" style="background:#f57c00; border-color:#ffb74d;">üíÄ È°ØÁ§∫ÁµêÁÆó‰ªãÈù¢</button>
        <button class="debug-btn" onclick="triggerBearDeath()" style="background:#d32f2f; border-color:#ef5350;">üêª Ê∏¨Ë©¶ËÆäË∫´</button>
    </div>
    <div class="debug-group">
        <label>Êï∏Â≠óÁ∏ÆÊîæ</label>
        <button class="debug-btn" onclick="testDigits(2)">2‰Ωç</button>
        <button class="debug-btn" onclick="testDigits(5)">5‰Ωç</button>
    </div>
    <div class="debug-group">
        <label>HP / Bar Ê∏¨Ë©¶</label>
        <button class="debug-btn" onclick="testHP(1)">1 HP</button>
        <button class="debug-btn" onclick="testHP(3)">ÂÖ®Êªø</button>
        <input type="range" id="debug-slider" min="0" max="100" value="100" oninput="testBar(this.value)" style="width:95%; margin-top:5px;">
    </div>
    <button class="debug-btn" style="width:100%; background:#c62828;" onclick="this.parentElement.style.display='none'">Èö±ËóèÈù¢Êùø</button>
</div>

<script>
    /* --- Ê†∏ÂøÉËÆäÊï∏ --- */
    const MAX_TIME = 10.0;
    const MAX_HEARTS = 3;
    const TIME_PENALTY = 1.0;
    const TIME_BONUS = 0.5;
    const COMBO_WINDOW_MAX = 1000; 
    const COMBO_WINDOW_MIN = 300; 

    let gameState = {
        isPlaying: false,
        score: 0,
        hearts: 3,
        timeLeft: MAX_TIME,
        combo: 0,
        round: 1, // ÁèæÂú®ÊòØÁ¨¨ÂπæËº™
        currentTarget: 1, // Áï∂ÂâçË¶ÅÈªûÁöÑÊï∏Â≠ó
        maxTargetInWave: 9, // Êú¨Ëº™ÊúÄÂ§ßÊï∏Â≠ó
        lastClickTime: 0,
        numbersOnGrid: [] 
    };

    let gameTimer = null;
    let playerName = "YOU"; 
    let lastInputTime = 0;
    const INPUT_COOLDOWN = 60; 

    /* --- DOM Âø´Âèñ --- */
    const timerEls = {
        container: document.getElementById('ui-timer-container'),
        d1: document.getElementById('timer-d1'),
        d2: document.getElementById('timer-d2'),
        d3: document.getElementById('timer-d3'),
        d4: document.getElementById('timer-d4')
    };
    const comboBarFill = document.getElementById('ui-combo-bar-fill');
    const cardSlots = Array.from(document.querySelectorAll('.card-slot'));

    /* --- ÂàùÂßãÂåñ --- */
    window.addEventListener('resize', resizeGame);
    window.addEventListener('load', () => {
        resizeGame();
        preloadGameAssets();
        initLeaderboard(); 
        
        cardSlots.forEach((slot, index) => {
            setupButtonFeedback(slot, true, index);
        });

        setupButtonFeedback(document.getElementById('btn-start'));
        setupButtonFeedback(document.getElementById('btn-coffee'));
        setupButtonFeedback(document.getElementById('btn-share'));
        setupButtonFeedback(document.getElementById('res-btn-retry'));
        setupButtonFeedback(document.getElementById('res-btn-coffee'));
        setupButtonFeedback(document.getElementById('res-btn-share'));
        setupButtonFeedback(document.getElementById('btn-confirm-name'));

        document.getElementById('ui-input-field').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') submitName();
        });
        
        updateScoreDisplay(0);
        updateTimerDisplay(MAX_TIME);
    });

    function resizeGame() {
        const container = document.getElementById('game-container');
        const scale = Math.min(window.innerWidth / 720, window.innerHeight / 1280);
        container.style.transform = `scale(${scale})`;
    }

    function preloadGameAssets() {
        const assets = [
            'num_ui_0.webp', 'num_ui_1.webp', 'num_ui_2.webp', 'num_ui_3.webp', 'num_ui_4.webp',
            'num_ui_5.webp', 'num_ui_6.webp', 'num_ui_7.webp', 'num_ui_8.webp', 'num_ui_9.webp', 'num_ui_colon.webp',
            'num_grid_0.webp', 'num_grid_1.webp', 'num_grid_2.webp', 'num_grid_3.webp', 'num_grid_4.webp',
            'num_grid_5.webp', 'num_grid_6.webp', 'num_grid_7.webp', 'num_grid_8.webp', 'num_grid_9.webp',
            'ui_rank_row_normal.webp', 'ui_rank_row_self.webp', 'logo_rank_title.webp',
            'icon_star.webp', 'vfx_thunder.webp', 'ui_text_hit.webp', 'character_bear_devil.webp',
            'ui_panel_input_name.webp'
        ];
        assets.forEach(name => { const img = new Image(); img.src = 'assets/' + name; });
    }

    /* --- ÈÅäÊà≤ÊµÅÁ®ã --- */
    function startGameProcess() {
        // Reset State
        gameState = {
            isPlaying: true,
            score: 0,
            hearts: MAX_HEARTS,
            timeLeft: MAX_TIME,
            combo: 0,
            round: 1,
            currentTarget: 1,
            maxTargetInWave: 9,
            lastClickTime: Date.now(),
            numbersOnGrid: []
        };

        // UI Reset
        document.getElementById('ui-home-screen').style.display = 'none';
        document.getElementById('ui-result-screen').style.display = 'none'; 
        document.getElementById('ui-input-screen').style.display = 'none';
        document.getElementById('ui-character-bear').style.display = 'block';
        document.getElementById('ui-character-bear').classList.remove('effect-sink');
        document.getElementById('ui-character-devil').style.display = 'none';
        document.getElementById('ui-character-devil').classList.remove('effect-rise');
        timerEls.container.classList.remove('timer-panic-mode');
        updateScoreDisplay(0);
        testHP(3);
        
        // ÂÄíÊï∏ÂãïÁï´
        const ids = ['ui-text-3', 'ui-text-2', 'ui-text-1', 'ui-text-go'];
        let delay = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.style.display = 'none';
            el.classList.remove('anim-pop');
        });
        ids.forEach((id, index) => {
            setTimeout(() => {
                if(index > 0) document.getElementById(ids[index-1]).style.display = 'none';
                const el = document.getElementById(id);
                el.style.display = 'block';
                el.classList.add('anim-pop');
                if (id === 'ui-text-go') {
                    setTimeout(() => { 
                        el.style.display = 'none'; 
                        startGameLoop(); 
                    }, 500);
                }
            }, delay);
            delay += 800;
        });
    }

    function startGameLoop() {
        spawnWave(); // Áî¢ÁîüÁ¨¨‰∏ÄÊ≥¢
        gameState.lastClickTime = Date.now();
        
        // ‰∏ªË®àÊôÇÂô®
        if(gameTimer) clearInterval(gameTimer);
        gameTimer = setInterval(() => {
            if(!gameState.isPlaying) return;

            gameState.timeLeft -= 0.01; 
            
            // ‰ΩéÊôÇË≠¶Á§∫
            if(gameState.timeLeft <= 3.0 && !timerEls.container.classList.contains('timer-panic-mode')) {
                timerEls.container.classList.add('timer-panic-mode');
            } else if (gameState.timeLeft > 3.0) {
                timerEls.container.classList.remove('timer-panic-mode');
            }

            if (gameState.timeLeft <= 0) {
                gameState.timeLeft = 0;
                gameOver();
            }
            updateTimerDisplay(gameState.timeLeft);
            updateComboBar();
        }, 10);
    }

    function stopGame() {
        gameState.isPlaying = false;
        if(gameTimer) clearInterval(gameTimer);
        timerEls.container.classList.remove('timer-panic-mode');
    }

    function restartGame() {
        stopGame();
        startGameProcess();
    }

    /* --- Ê†∏ÂøÉÈÇèËºØ (Wave Mode) --- */
    function spawnWave() {
        // [‰øÆÊ≠£] ÈÇèËºØÔºöÊØèËº™Ëµ∑Èªû = Ëº™Êï∏
        // Round 1: 1~9
        // Round 2: 2~10
        // Round 3: 3~11
        const startNum = gameState.round;
        gameState.currentTarget = startNum;
        gameState.maxTargetInWave = startNum + 8;

        // Áî¢ÁîüÊï∏Â≠ó
        let nums = [];
        for(let i=0; i<9; i++) nums.push(startNum + i);
        // Ê¥óÁâå
        for (let i = nums.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [nums[i], nums[j]] = [nums[j], nums[i]];
        }
        gameState.numbersOnGrid = nums;

        // Ê∏≤Êüì
        cardSlots.forEach((slot, i) => {
            slot.style.display = 'block'; 
            slot.style.opacity = '1';
            slot.style.pointerEvents = 'auto';
            setGridNumber(i, nums[i]);
        });
    }

    function handleCardTap(index) {
        if(!gameState.isPlaying) return;

        const clickedNum = gameState.numbersOnGrid[index];
        const slot = cardSlots[index];

        // ÂøÖÈ†àÈªûÊìäÁï∂ÂâçÊúÄÂ∞èÁöÑÊï∏Â≠ó
        if (clickedNum === gameState.currentTarget) {
            // --- HIT ---
            const cx = parseInt(slot.style.left);
            const cy = parseInt(slot.style.top);
            createStarBurst(cx, cy);
            createHitEffect(cx, cy, gameState.combo + 1);
            
            gameState.currentTarget++;
            gameState.combo++;
            gameState.score += (100 + gameState.combo * 10);
            gameState.timeLeft = Math.min(MAX_TIME, gameState.timeLeft + TIME_BONUS);
            gameState.lastClickTime = Date.now();

            updateScoreDisplay(gameState.score);
            
            // [‰øÆÊ≠£] Âç°ÁâáÈö±Ëóè (Á≠âÂæÖÊï¥Ê≥¢Ê∏ÖÈô§)
            slot.style.opacity = '0';
            slot.style.pointerEvents = 'none';

            // [‰øÆÊ≠£] Ê™¢Êü•ÈÄôÊ≥¢ÊòØÂê¶Ê∏ÖÁ©∫
            if (gameState.currentTarget > gameState.maxTargetInWave) {
                gameState.round++;
                // ÂõûË°Ä (ÊØè5Ëº™)
                if (gameState.round % 5 === 1 && gameState.hearts < MAX_HEARTS) {
                    gameState.hearts++;
                    testHP(gameState.hearts);
                }
                setTimeout(spawnWave, 200); // Âª∂ÈÅ≤‰∏ÄÈªûÈªûÁîüÊàê‰∏ã‰∏ÄÊ≥¢
            }

        } else {
            // --- MISS ---
            gameState.hearts--;
            testHP(gameState.hearts);
            gameState.timeLeft -= TIME_PENALTY;
            gameState.combo = 0;
            
            handleBearHit(); 

            if(gameState.hearts <= 0) {
                gameOver();
            }
        }
    }

    function updateComboBar() {
        if (gameState.combo === 0) {
            comboBarFill.style.transform = `translate(-50%, -50%) scaleX(0)`;
            return;
        }
        
        const now = Date.now();
        const timePassed = now - gameState.lastClickTime;
        const allowedWindow = Math.max(COMBO_WINDOW_MIN, COMBO_WINDOW_MAX - (gameState.combo * 20)); 
        
        let pct = 1 - (timePassed / allowedWindow);
        if (pct <= 0) {
            pct = 0;
            gameState.combo = 0; 
        }
        
        comboBarFill.style.transform = `translate(-50%, -50%) scaleX(${pct})`;
    }

    function gameOver() {
        stopGame();
        triggerBearDeath();
    }

    /* --- Ë¶ñË¶∫ËàáÁâπÊïà --- */
    function setGridNumber(index, number) {
        const slot = cardSlots[index];
        const wrapper = slot.querySelector('.num-wrapper');
        const numStr = number.toString();
        wrapper.innerHTML = '';
        for (let char of numStr) {
            const img = document.createElement('img'); img.src = `assets/num_grid_${char}.webp`;
            wrapper.appendChild(img);
        }
        let scaleValue = 1.0;
        const len = numStr.length;
        if (len === 2) scaleValue = 0.8;
        else if (len === 3) scaleValue = 0.55;
        else if (len >= 4) scaleValue = 0.4;
        wrapper.style.transform = `translate(-50%, -50%) scale(${scaleValue})`;
    }

    function createStarBurst(x, y) {
        const container = document.getElementById('game-container');
        for (let i = 0; i < 5; i++) {
            const star = document.createElement('img');
            star.src = 'assets/icon_star.webp';
            star.className = 'particle-star';
            const size = Math.random() * 40 + 60; 
            star.style.width = `${size}px`; star.style.height = `${size}px`;
            star.style.left = `${x}px`; star.style.top = `${y}px`;
            star.style.transform = `translate(-50%, -50%) scale(0.5)`;
            const angle = Math.random() * Math.PI * 2; 
            const velocity = Math.random() * 150 + 100; 
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;
            const rot = Math.random() * 720; 
            container.appendChild(star);
            requestAnimationFrame(() => {
                star.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(0) rotate(${rot}deg)`;
                star.style.opacity = '0';
            });
            setTimeout(() => star.remove(), 800);
        }
    }

    function createHitEffect(x, y, comboVal) {
        const container = document.getElementById('game-container');
        const wrapper = document.createElement('div');
        wrapper.className = 'hit-effect-wrapper';
        wrapper.style.left = `${x}px`;
        wrapper.style.top = `${y - 50}px`; 
        const valStr = comboVal.toString();
        for (let char of valStr) {
            const digit = document.createElement('img');
            digit.src = `assets/num_ui_${char}.webp`;
            digit.className = 'hit-num-digit';
            wrapper.appendChild(digit);
        }
        const hitImg = document.createElement('img');
        hitImg.src = 'assets/ui_text_hit.webp';
        hitImg.className = 'hit-text-img';
        wrapper.appendChild(hitImg);
        container.appendChild(wrapper);
        setTimeout(() => wrapper.remove(), 1500); 
    }

    function handleBearHit() {
        const bearNormal = document.getElementById('ui-character-bear');
        const bearDevil = document.getElementById('ui-character-devil');
        const activeBear = (bearDevil.style.display !== 'none' && bearDevil.classList.contains('effect-rise')) ? bearDevil : bearNormal;
        activeBear.classList.remove('effect-shake');
        void activeBear.offsetWidth; 
        activeBear.classList.add('effect-shake');
        setTimeout(() => activeBear.classList.remove('effect-shake'), 200);
    }

    function triggerBearDeath() {
        const bearNormal = document.getElementById('ui-character-bear');
        const bearDevil = document.getElementById('ui-character-devil');
        bearNormal.classList.add('effect-sink');
        setTimeout(() => {
            bearNormal.style.display = 'none'; 
            bearDevil.style.display = 'block'; 
            bearDevil.classList.add('effect-rise');
            setTimeout(showInputScreen, 1500); 
        }, 1000); 
    }

    function setupButtonFeedback(element, isCard = false, index = -1) {
        if (!element) return;
        const pressClass = isCard ? 'pressed' : 'btn-pressed';
        element.addEventListener('pointerdown', (e) => {
            const now = Date.now();
            if (now - lastInputTime < INPUT_COOLDOWN) return; 
            lastInputTime = now;

            element.classList.add(pressClass);
            element.setPointerCapture(e.pointerId);

            if (isCard && gameState.isPlaying) {
                handleCardTap(index);
            }
        });
        const release = () => { element.classList.remove(pressClass); };
        element.addEventListener('pointerup', release);
        element.addEventListener('pointerleave', release);
        element.addEventListener('pointercancel', release);
    }

    function showInputScreen() {
        document.getElementById('ui-input-screen').style.display = 'block';
        document.getElementById('ui-input-field').focus();
    }

    function submitName() {
        const inputVal = document.getElementById('ui-input-field').value.trim();
        if (inputVal) playerName = inputVal.substring(0, 8); 
        document.getElementById('ui-input-screen').style.display = 'none';
        showResultScreen();
    }

    function showResultScreen() {
        document.getElementById('ui-result-screen').style.display = 'block';
        document.getElementById('my-rank-name').textContent = playerName;
        const myScoreContainer = document.getElementById('my-rank-score-container');
        if(myScoreContainer) myScoreContainer.innerHTML = getScoreHtml(gameState.score);
    }

    function updateScoreDisplay(newScore) {
        const scoreContainer = document.getElementById('ui-game-score');
        scoreContainer.innerHTML = ''; 
        const scoreStr = newScore.toString().padStart(8, '0');
        for (let char of scoreStr) {
            const img = document.createElement('img');
            img.src = `assets/num_grid_${char}.webp`;
            img.className = 'score-digit-img';
            scoreContainer.appendChild(img);
        }
    }

    function getScoreHtml(score) {
        const str = score.toString().padStart(8, '0');
        let html = '';
        for(let char of str) html += `<img src="assets/num_grid_${char}.webp" class="rank-score-digit">`;
        return html;
    }

    function updateTimerDisplay(totalSecs) {
        const seconds = Math.floor(totalSecs);
        const millis = Math.floor((totalSecs % 1) * 100);
        const sStr = seconds.toString().padStart(2, '0');
        const mStr = millis.toString().padStart(2, '0');
        if (timerEls.d1.src.indexOf(`num_ui_${sStr[0]}.webp`) === -1) timerEls.d1.src = `assets/num_ui_${sStr[0]}.webp`;
        if (timerEls.d2.src.indexOf(`num_ui_${sStr[1]}.webp`) === -1) timerEls.d2.src = `assets/num_ui_${sStr[1]}.webp`;
        if (timerEls.d3.src.indexOf(`num_ui_${mStr[0]}.webp`) === -1) timerEls.d3.src = `assets/num_ui_${mStr[0]}.webp`;
        if (timerEls.d4.src.indexOf(`num_ui_${mStr[1]}.webp`) === -1) timerEls.d4.src = `assets/num_ui_${mStr[1]}.webp`;
    }

    function initLeaderboard() {
        const list = document.getElementById('rank-scroll-view');
        if(!list) return;
        list.innerHTML = ''; 
        const flags = ['üáπüáº', 'üáØüáµ', 'üá∫üá∏', 'üá∞üá∑', 'üá®üá¶', 'üá¨üáß', 'üá¶üá∫', 'üá´üá∑', 'üá©üá™', 'üáπüá≠'];
        for(let i=1; i<=100; i++) {
            const row = document.createElement('div');
            row.className = 'rank-row';
            const rankStr = i;
            let nameRaw = `Player${i}`;
            let scoreRaw = 99999 - i * 100;
            const flagEmoji = flags[i % flags.length];
            let rankFontSize = i >= 10000 ? '26px' : (i >= 1000 ? '32px' : '40px'); 
            row.innerHTML = `
                <span class="rank-num" style="font-size:${rankFontSize}">${rankStr}</span>
                <span class="rank-name">${nameRaw}</span>
                <span class="rank-flag">${flagEmoji}</span>
                <div class="rank-score">${getScoreHtml(scoreRaw)}</div>
            `;
            list.appendChild(row);
        }
    }

    function testDigits(d) {
        const val = Math.pow(10, d) - 1;
        cardSlots.forEach((_, i) => setGridNumber(i, val));
    }
    function testHP(hp) {
        for (let i = 1; i <= 3; i++) document.getElementById(`ui-heart-${i}`).style.opacity = i <= hp ? "1" : "0.2";
    }
    function testBar(val) {
        comboBarFill.style.transform = `translate(-50%, -50%) scaleX(${val/100})`;
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel JD - Bear Flash Tap Master</title>
    <style>
        /* --- Âü∫Á§éÁí∞Â¢ÉË®≠ÂÆö --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; font-family: sans-serif; user-select: none; }
        
        #game-container { 
            width: 720px; height: 1280px; 
            position: relative; overflow: hidden; 
            background: #1a1a2e; 
            transform-origin: center; flex-shrink: 0; 
            touch-action: none; 
        }
        
        .ui-element { position: absolute; transform: translate(-50%, -50%); transform-origin: center; user-select: none; -webkit-user-drag: none; pointer-events: none; }

        /* --- 1. ËÉåÊôØËàáËßíËâ≤ --- */
        #bg-main { width: 720px; height: 1280px; left: 360px; top: 640px; z-index: 0; }
        
        /* ËÉåÊôØÈñÉÈõª VFX - È†êË®≠Èö±ËóèÔºåÁî± JS ÊéßÂà∂ class */
        .vfx-thunder { width: 244px; height: 234px; z-index: 1; pointer-events: none; opacity: 0; transition: opacity 0.1s; }
        #vfx-thunder-left { left: 11px; top: 291px; transform: translate(-50%, -50%) scaleX(-1); }
        #vfx-thunder-right { left: 711px; top: 293px; transform: translate(-50%, -50%); }
        .thunder-active { opacity: 1 !important; animation: thunder-flicker 0.5s infinite; }
        @keyframes thunder-flicker { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* ËßíËâ≤Ë®≠ÂÆö */
        #ui-character-bear, #ui-character-devil { width: 496px; height: 612px; left: 360px; top: 460px; z-index: 2; transition: filter 0.1s; }
        #ui-character-devil { display: none; }

        /* ËßíËâ≤ÂãïÁï´ */
        @keyframes anim-shake {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-51%, -50%) rotate(-1deg); } 
            50% { transform: translate(-49%, -50%) rotate(1deg); }  
            75% { transform: translate(-50.5%, -50%) rotate(-0.5deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        .effect-shake { animation: anim-shake 0.15s ease-in-out; }

        @keyframes anim-sink {
            0% { transform: translate(-50%, -50%); opacity: 1; filter: grayscale(0); }
            20% { transform: translate(-50%, -50%); opacity: 1; filter: grayscale(1); }
            100% { transform: translate(-50%, -20%); opacity: 0; filter: grayscale(1); }
        }
        .effect-sink { animation: anim-sink 1.0s ease-in forwards; }

        @keyframes anim-rise {
            0% { transform: translate(-50%, -20%); opacity: 0; }
            100% { transform: translate(-50%, -50%); opacity: 1; }
        }
        .effect-rise { display: block !important; animation: anim-rise 0.8s ease-out forwards; }

        #ui-panel-main { width: 720px; height: 810px; left: 360px; top: 875px; z-index: 5; }
        
        /* --- 2. ‚è≥ Ë®àÊôÇÂô®ÂÆπÂô® --- */
        #ui-timer-container {
            position: absolute; left: 360px; top: 98px; width: 300px; height: 80px;
            transform: translate(-50%, -50%) scale(1.2); z-index: 30;
            display: flex; justify-content: center; align-items: center; gap: 0; pointer-events: none;
        }
        .timer-digit { height: 100%; width: 50px; object-fit: contain; margin: 0 -3px; }
        .timer-colon-slot { height: 60%; width: 30px; object-fit: contain; margin-top: -5px; }

        /* --- 3. ÈÅäÊà≤Ê†∏ÂøÉ UI --- */
        #ui-text-combo-time { width: 189px; height: 32px; left: 129px; top: 501px; z-index: 20; }
        #ui-combo-bar-bg { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 20; }
        #ui-combo-bar-fill { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 21; transform-origin: left; transform: translate(-50%, -50%) scaleX(0); transition: transform 0.1s linear; }
        #ui-combo-bar-cover { width: 25px; height: 26px; left: 237px; top: 501px; z-index: 22; pointer-events: none; }
        
        #ui-game-score {
            position: absolute; left: 402px; width: 300px; top: 100px; transform: translateY(-50%);
            display: flex; justify-content: flex-end; align-items: center; z-index: 30; pointer-events: none; gap: 1px;
        }
        .score-digit-img { height: 20px; width: auto; object-fit: contain; }

        /* HIT ÁâπÊïàÂÆπÂô® */
        .hit-effect-wrapper {
            position: absolute; display: flex; flex-direction: row; align-items: center; justify-content: center;
            gap: 5px; pointer-events: none; 
            z-index: 999; transform: translate(-50%, -50%);
            animation: hit-float 0.8s cubic-bezier(0.1, 0.8, 0.2, 1) forwards;
        }
        .hit-num-digit { height: 40px; width: auto; object-fit: contain; margin: 0 -10px; }
        .hit-text-img { width: 74px; height: 38px; object-fit: contain; margin-left: 5px; }
        @keyframes hit-float {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -100%) scale(1.3); opacity: 1; } 
            100% { transform: translate(-50%, -200%) scale(1.0); opacity: 0; } 
        }

        /* ÈåØË™§ÁâπÊïà */
        .wrong-shake { animation: card-shake-red 0.4s ease-in-out; filter: sepia(1) hue-rotate(-50deg) saturate(3); }
        @keyframes card-shake-red { 0%, 100% { transform: translate(-50%, -50%); } 20% { transform: translate(-60%, -50%); } 40% { transform: translate(-40%, -50%); } 60% { transform: translate(-55%, -50%); } 80% { transform: translate(-45%, -50%); } }

        /* ‰πùÂÆÆÊ†ºÊåâÈàï */
        #game-grid { position: absolute; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .card-slot { 
            position: absolute; width: 230px; height: 230px; transform: translate(-50%, -50%); 
            pointer-events: auto; cursor: pointer; transition: transform 0.08s; touch-action: manipulation; 
        }
        .card-slot.pressed { transform: translate(-50%, -50%) scale(0.92); filter: brightness(0.9); }
        .card-slot.vanished { opacity: 0; pointer-events: none; transform: translate(-50%, -50%) scale(0.5); transition: opacity 0.2s, transform 0.2s; }
        
        .btn-card-base { width: 100%; height: 100%; display: block; pointer-events: none;}
        .num-wrapper { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; gap: -10px; pointer-events: none; width: 100%; }
        .num-wrapper img { width: 121px; height: 134px; flex-shrink: 0; }

        /* ÊòüÊòüÁ≤íÂ≠êÁâπÊïà */
        .particle-star { 
            position: absolute; width: 44px; height: 44px; pointer-events: none; z-index: 999; 
            transform-origin: center; transition: transform 0.8s, opacity 0.8s; opacity: 1; 
        }

        .hud-item { z-index: 15; transition: opacity 0.2s; }
        #ui-heart-1 { width: 44px; height: 38px; left: 53px; top: 100px; }
        #ui-heart-2 { width: 44px; height: 38px; left: 101px; top: 100px; }
        #ui-heart-3 { width: 44px; height: 38px; left: 149px; top: 100px; }
        #ui-icon-star { width: 44px; height: 44px; left: 528px; top: 99px; z-index: 15; }

        .countdown-img { z-index: 50; display: none; pointer-events: none; }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; } }
        .anim-pop { animation: popIn 0.5s ease-out forwards; }
        #ui-text-3 { width: 167px; height: 211px; left: 358px; top: 757px; }
        #ui-text-2 { width: 169px; height: 211px; left: 356px; top: 757px; }
        #ui-text-1 { width: 101px; height: 212px; left: 355px; top: 757px; }
        #ui-text-go { width: 343px; height: 185px; left: 357px; top: 757px; }

        /* --- UI Layers --- */
        #ui-home-screen, #ui-input-screen, #ui-result-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 100; }
        #ui-input-screen { z-index: 180; display: none; }
        #ui-result-screen { z-index: 200; display: none; }
        
        #ui-mask { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        #ui-panel-start { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 101; }
        #character-home { width: 547px; height: 496px; left: 361px; top: 676px; z-index: 102; }
        #logo-main { width: 514px; height: 216px; left: 369px; top: 315px; z-index: 102; }
        
        #btn-coffee, #btn-share, #btn-start { z-index: 103; cursor: pointer; transition: transform 0.1s; position: absolute; transform: translate(-50%, -50%); }
        #btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; }
        #btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; }
        #btn-start { width: 522px; height: 101px; left: 360px; top: 981px; }
        .btn-pressed { transform: translate(-50%, -50%) scale(0.95) !important; filter: brightness(0.9); }

        #ui-text-start { width: 364px; height: 56px; left: 362px; top: 985px; z-index: 104; pointer-events: none; transition: transform 0.1s; transform: translate(-50%, -50%); }
        
        /* Input Screen */
        #ui-panel-input { width: 540px; height: 240px; left: 360px; top: 600px; z-index: 181; }
        #ui-input-field {
            position: absolute; left: 362px; top: 640px; transform: translate(-50%, -50%);
            width: 320px; height: 60px; z-index: 182;
            background: transparent; border: none; outline: none;
            color: #fff; font-size: 36px; font-weight: 900; text-align: center;
            font-family: monospace; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        #btn-confirm-name { width: 522px; height: 101px; left: 360px; top: 800px; z-index: 182; cursor: pointer; position: absolute; transform: translate(-50%, -50%);}

        /* Result Screen */
        #res-panel { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 201; }
        #res-panel-rank { width: 547px; height: 653px; left: 361px; top: 598px; z-index: 202; }
        #logo-rank-title { width: 378px; height: 162px; left: 360px; top: 184px; z-index: 205; }
        #rank-content-layer { position: absolute; left: 361px; top: 598px; width: 540px; height: 600px; border-radius: 30px; overflow: hidden; transform: translate(-50%, -50%); z-index: 203; }
        #rank-scroll-view { width: 100%; height: 100%; overflow-y: scroll; -webkit-overflow-scrolling: touch; scrollbar-width: none; display: flex; flex-direction: column; align-items: center; padding-top: 10px; padding-bottom: 120px; }
        #rank-scroll-view::-webkit-scrollbar { display: none; }

        .rank-row {
            width: 522px; height: 101px; margin-bottom: -2px; 
            background-image: url('assets/ui_rank_row_normal.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            flex-shrink: 0; position: relative; font-weight: 900; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        .rank-num { position: absolute; left: 20px; width: 82px; top: 50%; transform: translateY(-50%); text-align: left; color: rgb(255, 222, 0); font-size: 40px; }
        .rank-name { position: absolute; left: 106px; width: 152px; top: 50%; transform: translateY(-50%); text-align: left; color: rgb(255, 255, 255); font-size: 28px; white-space: nowrap; overflow: hidden; }
        .rank-flag { position: absolute; left: 260px; top: 50%; transform: translateY(-50%); font-size: 28px; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5)); z-index: 2; }
        .rank-score { position: absolute; left: 258px; width: 240px; top: 50%; transform: translateY(-50%); display: flex; justify-content: flex-end; align-items: center; gap: -2px; }
        .rank-score-digit { height: 28px; width: auto; object-fit: contain; }

        #rank-fixed-row {
            position: absolute; left: 360px; top: 855px; width: 522px; height: 101px;
            transform: translate(-50%, -50%); z-index: 205; 
            background-image: url('assets/ui_rank_row_self.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center; font-weight: 900; pointer-events: none;
        }

        #res-btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; z-index: 203; cursor: pointer; position: absolute; transform: translate(-50%, -50%); }
        #res-btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; z-index: 203; cursor: pointer; position: absolute; transform: translate(-50%, -50%); }
        #res-btn-retry { width: 522px; height: 101px; left: 360px; top: 981px; z-index: 203; cursor: pointer; position: absolute; transform: translate(-50%, -50%); }
        #ui-text-retry { width: 323px; height: 55px; left: 362px; top: 985px; z-index: 204; pointer-events: none; transition: transform 0.1s; transform: translate(-50%, -50%); }

        #bg-bar-top { width: 720px; height: 53px; left: 360px; top: 27px; z-index: 20; }
        #bg-bar-bottom { width: 720px; height: 69px; left: 360px; top: 1246px; z-index: 20; }
    </style>
</head>
<body>

<audio id="bgm-player" src="assets/bgm.mp3" loop preload="auto"></audio>

<div id="game-container">
    <img src="assets/bg_main.webp" class="ui-element" id="bg-main">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-left">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-right">
    
    <img src="assets/character_bear.webp" class="ui-element" id="ui-character-bear">
    <img src="assets/character_bear_devil.webp" class="ui-element" id="ui-character-devil">

    <img src="assets/panel_main.webp" class="ui-element" id="ui-panel-main">

    <div id="ui-timer-container">
        <img id="timer-d1" class="timer-digit" src="assets/num_ui_1.webp">
        <img id="timer-d2" class="timer-digit" src="assets/num_ui_0.webp">
        <img class="timer-colon-slot" src="assets/num_ui_colon.webp">
        <img id="timer-d3" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d4" class="timer-digit" src="assets/num_ui_0.webp">
    </div>

    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-1">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-2">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-3">
    <img src="assets/icon_star.webp" class="ui-element" id="ui-icon-star">
    
    <div id="ui-game-score">
        <img src="assets/num_grid_0.webp" class="score-digit-img">
    </div>

    <img src="assets/ui_text_combo_time.webp" class="ui-element" id="ui-text-combo-time">
    <img src="assets/ui_combo_bar_bg.webp" class="ui-element" id="ui-combo-bar-bg">
    <img src="assets/ui_combo_bar_fill.webp" class="ui-element" id="ui-combo-bar-fill">
    <img src="assets/ui_combo_bar_cover.webp" class="ui-element" id="ui-combo-bar-cover">

    <div id="game-grid">
        <div class="card-slot" id="slot-0" style="left: 130px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-1" style="left: 360px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-2" style="left: 590px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-3" style="left: 130px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-4" style="left: 360px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-5" style="left: 590px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-6" style="left: 130px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-7" style="left: 360px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
        <div class="card-slot" id="slot-8" style="left: 590px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"></div></div>
    </div>

    <img src="assets/ui_text_3.webp" class="ui-element countdown-img" id="ui-text-3">
    <img src="assets/ui_text_2.webp" class="ui-element countdown-img" id="ui-text-2">
    <img src="assets/ui_text_1.webp" class="ui-element countdown-img" id="ui-text-1">
    <img src="assets/ui_text_go.webp" class="ui-element countdown-img" id="ui-text-go">

    <div id="ui-home-screen">
        <div id="ui-mask"></div>
        <img src="assets/ui_panel_start.webp" class="ui-element" id="ui-panel-start">
        <img src="assets/character_home.webp" class="ui-element" id="character-home">
        <img src="assets/logo_main.webp" class="ui-element" id="logo-main">
        <img src="assets/btn_coffee.webp" class="ui-element" id="btn-coffee">
        <img src="assets/btn_share.webp" class="ui-element" id="btn-share">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-start">
        <img src="assets/ui_text_start.webp" class="ui-element" id="ui-text-start">
    </div>

    <div id="ui-input-screen">
        <div style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);"></div>
        <img src="assets/ui_panel_input_name.webp" class="ui-element" id="ui-panel-input">
        <input type="text" id="ui-input-field" placeholder="INPUT NAME" maxlength="8">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-confirm-name">
    </div>

    <div id="ui-result-screen">
        <div id="ui-mask-result" style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);"></div>
        <img src="assets/logo_rank_title.webp" class="ui-element" id="logo-rank-title">
        <img src="assets/ui_panel_start.webp" class="ui-element" id="res-panel">
        <img src="assets/ui_panel_rank.webp" class="ui-element" id="res-panel-rank"> 
        <div id="rank-content-layer">
            <div id="rank-scroll-view"></div>
        </div>
        <div id="rank-fixed-row">
            <span class="rank-num">?</span>
            <span class="rank-name" id="my-rank-name">YOU</span>
            <span class="rank-flag">üáπüáº</span>
            <div class="rank-score" id="my-rank-score-container"></div>
        </div>
        <img src="assets/btn_coffee.webp" class="ui-element" id="res-btn-coffee">
        <img src="assets/btn_share.webp" class="ui-element" id="res-btn-share">
        <img src="assets/btn_start.webp" class="ui-element" id="res-btn-retry">
        <img src="assets/ui_text_retry.webp" class="ui-element" id="ui-text-retry">
    </div>

    <img src="assets/bg_bar_top.webp" class="ui-element" id="bg-bar-top">
    <img src="assets/bg_bar_bottom.webp" class="ui-element" id="bg-bar-bottom">
</div>

<script type="module">
    // --- 1. Firebase Êï¥Âêà (Pixel JD Logic) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDuA9GeD7AaHwayISu_vf3DJldOP9jq-4A",
        authDomain: "bearflashtap.firebaseapp.com",
        projectId: "bearflashtap",
        storageBucket: "bearflashtap.firebasestorage.app",
        messagingSenderId: "517068547423",
        appId: "1:517068547423:web:36b6dd81d8e330f97582ea"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const scoresCol = collection(db, "leaderboard");

    // --- 2. ÈÅäÊà≤ÁãÄÊÖãËàáË≥áÊ∫ê (Logic Adapter) ---
    let playerName = localStorage.getItem('pixelJD_Player') || "";
    let state = {
        currentTime: 10.0,
        score: 0,
        nextNum: 1,
        startNumInRound: 1,
        rounds: 0,
        isPlaying: false,
        lives: 3,
        loop: null,
        combo: 0,
        lastTapTime: 0,
        gridValues: [] // ÂÑ≤Â≠òÊØèÂÄãÊ†ºÂ≠êÁöÑÊï∏ÂÄº
    };

    // Èü≥ÊïàÁÆ°ÁêÜ
    let audioCtx = null;
    const bgm = document.getElementById('bgm-player');
    let isMusicPlaying = false;

    function initAudio() { 
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
        if (audioCtx.state === 'suspended') audioCtx.resume(); 
    }
    
    function toggleBGM(play) {
        if (play && !isMusicPlaying) { 
            bgm.volume = 0.4; 
            bgm.play().then(() => isMusicPlaying = true).catch(()=>{}); 
        } else if(!play) { 
            bgm.pause(); bgm.currentTime = 0; isMusicPlaying = false; 
        }
    }

    function playSnd(type) {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        const now = audioCtx.currentTime;
        
        if (type === 'hit') {
            o.frequency.setValueAtTime(800 + (Math.min(state.combo, 50) * 20), now);
            o.type = 'sine';
            g.gain.setValueAtTime(0.3, now);
            g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            o.start(); o.stop(now + 0.1);
        } else if (type === 'error') {
            o.frequency.setValueAtTime(150, now);
            o.type = 'sawtooth';
            g.gain.setValueAtTime(0.3, now);
            g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            o.start(); o.stop(now + 0.3);
        } else if (type === 'heal') {
            o.frequency.setValueAtTime(400, now);
            o.frequency.linearRampToValueAtTime(800, now + 0.2);
            g.gain.setValueAtTime(0.3, now);
            g.gain.linearRampToValueAtTime(0, now + 0.4);
            o.start(); o.stop(now + 0.4);
        }
        o.connect(g); g.connect(audioCtx.destination);
    }

    // --- 3. Ë¶ñË¶∫Êï¥ÂêàÈÅ©ÈÖçÂô® (UI Adapter) ---
    // Ë≤†Ë≤¨ÊääÈÇèËºØÊï∏ÂÄºËΩâÊèõÊàêÂúñÁâáÔºåÂ°ûÈÄ≤ Layout

    function resizeGame() {
        const container = document.getElementById('game-container');
        const scale = Math.min(window.innerWidth / 720, window.innerHeight / 1280);
        container.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame);
    window.addEventListener('load', resizeGame);

    // È°ØÁ§∫ÂàÜÊï∏ÂúñÁâá
    function renderScore(score) {
        const con = document.getElementById('ui-game-score');
        con.innerHTML = '';
        const str = score.toString().padStart(8, '0');
        for (let char of str) {
            const img = document.createElement('img');
            img.src = `assets/num_grid_${char}.webp`;
            img.className = 'score-digit-img';
            con.appendChild(img);
        }
    }

    // È°ØÁ§∫Ë®àÊôÇÂúñÁâá
    function renderTimer(time) {
        const sec = Math.floor(time);
        const ms = Math.floor((time - sec) * 100);
        const sStr = sec.toString().padStart(2, '0');
        const mStr = ms.toString().padStart(2, '0');
        
        document.getElementById('timer-d1').src = `assets/num_ui_${sStr[0]}.webp`;
        document.getElementById('timer-d2').src = `assets/num_ui_${sStr[1]}.webp`;
        document.getElementById('timer-d3').src = `assets/num_ui_${mStr[0]}.webp`;
        document.getElementById('timer-d4').src = `assets/num_ui_${mStr[1]}.webp`;
    }

    // È°ØÁ§∫ Grid Êï∏Â≠ó
    function renderGridSlot(index, number) {
        const slot = document.getElementById(`slot-${index}`);
        const wrapper = slot.querySelector('.num-wrapper');
        const numStr = number.toString();
        wrapper.innerHTML = '';
        
        for (let char of numStr) {
            const img = document.createElement('img'); 
            img.src = `assets/num_grid_${char}.webp`;
            wrapper.appendChild(img);
        }
        
        let scale = 1.0;
        if (numStr.length === 2) scale = 0.8;
        if (numStr.length >= 3) scale = 0.5;
        wrapper.style.transform = `translate(-50%, -50%) scale(${scale})`;
        
        slot.classList.remove('vanished');
    }

    // Ë¶ñË¶∫ÁâπÊïàÔºöÈªûÊìäÂÖâÊöà
    function spawnHitEffect(x, y, comboVal) {
        const container = document.getElementById('game-container');
        const wrapper = document.createElement('div');
        wrapper.className = 'hit-effect-wrapper';
        wrapper.style.left = `${x}px`;
        wrapper.style.top = `${y - 50}px`; 
        
        const valStr = comboVal.toString();
        for (let char of valStr) {
            const digit = document.createElement('img');
            digit.src = `assets/num_ui_${char}.webp`;
            digit.className = 'hit-num-digit';
            wrapper.appendChild(digit);
        }
        const hitImg = document.createElement('img');
        hitImg.src = 'assets/ui_text_hit.webp';
        hitImg.className = 'hit-text-img';
        wrapper.appendChild(hitImg);
        container.appendChild(wrapper);
        setTimeout(() => wrapper.remove(), 1000);
    }

    // Ë¶ñË¶∫ÁâπÊïàÔºöÊòüÊòü
    function spawnStars(x, y) {
        const container = document.getElementById('game-container');
        for (let i = 0; i < 5; i++) {
            const star = document.createElement('img');
            star.src = 'assets/icon_star.webp';
            star.className = 'particle-star';
            const size = Math.random() * 40 + 40;
            star.style.width = `${size}px`; star.style.height = `${size}px`;
            star.style.left = `${x}px`; star.style.top = `${y}px`;
            const angle = Math.random() * 6.28;
            const dist = Math.random() * 100 + 50;
            container.appendChild(star);
            
            requestAnimationFrame(() => {
                star.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px)) scale(0)`;
                star.style.opacity = '0';
            });
            setTimeout(() => star.remove(), 800);
        }
    }

    // ÁÜäÁÜäÂèóÊìäÂãïÁï´
    function triggerBearAnim() {
        const bear = document.getElementById('ui-character-bear');
        bear.classList.remove('effect-shake');
        void bear.offsetWidth; 
        bear.classList.add('effect-shake');
        
        // ÈñÉÈõªÁâπÊïà
        if (state.combo > 10) {
            document.querySelectorAll('.vfx-thunder').forEach(el => el.classList.add('thunder-active'));
            setTimeout(() => document.querySelectorAll('.vfx-thunder').forEach(el => el.classList.remove('thunder-active')), 200);
        }
    }

    // --- 4. Ê†∏ÂøÉÈÅäÊà≤ÈÇèËºØ (Game Loop) ---

    function initRound() {
        const nums = Array.from({length: 9}, (_, i) => state.startNumInRound + i).sort(() => Math.random() - 0.5);
        state.gridValues = nums;
        nums.forEach((val, i) => renderGridSlot(i, val));
    }

    function handleTap(index) {
        if (!state.isPlaying) return;
        const targetVal = state.gridValues[index];
        const slot = document.getElementById(`slot-${index}`);
        
        if (targetVal === state.nextNum) {
            // Success
            state.combo++;
            state.score += (10 + state.combo) * 10;
            state.currentTime += 0.5;
            state.nextNum++;
            state.lastTapTime = Date.now();
            
            // Visuals
            playSnd('hit');
            triggerBearAnim();
            renderScore(state.score);
            slot.classList.add('vanished'); // Èö±ËóèÂç°Áâá
            
            const rect = slot.getBoundingClientRect();
            // Ê≥®ÊÑèÔºöÂõ†ÁÇ∫Êúâ scaleÔºåÈúÄË¶ÅÊèõÁÆóÂõû 720x1280 ÁöÑÂ∫ßÊ®ôÁ≥ªÔºåÈÄôË£°Á∞°ÂåñÁõ¥Êé•Áî® slot ÁöÑ style
            const lx = parseInt(slot.style.left);
            const ly = parseInt(slot.style.top);
            
            spawnHitEffect(lx, ly, state.combo);
            spawnStars(lx, ly);

            // Combo Bar Êõ¥Êñ∞
            let windowTime = (state.combo > 50) ? 500 : 1000;
            
            // Check Round Clear
            if (targetVal === state.startNumInRound + 8) {
                state.rounds++;
                state.startNumInRound += 9;
                state.nextNum = state.startNumInRound;
                
                // Heal Logic
                if (state.rounds % 5 === 0 && state.lives < 3) {
                    state.lives++;
                    updateLivesUI();
                    playSnd('heal');
                }
                setTimeout(initRound, 100);
            }

        } else {
            // Fail
            playSnd('error');
            slot.classList.add('wrong-shake');
            setTimeout(() => slot.classList.remove('wrong-shake'), 400);
            
            state.combo = 0;
            state.lives--;
            state.currentTime -= 2.0;
            updateLivesUI();
            
            if (state.lives <= 0) endGame();
        }
    }

    function updateLivesUI() {
        for(let i=1; i<=3; i++) {
            document.getElementById(`ui-heart-${i}`).style.opacity = (i <= state.lives) ? "1" : "0.2";
        }
    }

    function startGame() {
        state.isPlaying = true;
        state.score = 0;
        state.lives = 3;
        state.currentTime = 10.0;
        state.combo = 0;
        state.rounds = 0;
        state.nextNum = 1;
        state.startNumInRound = 1;
        
        updateLivesUI();
        renderScore(0);
        initRound();
        
        // Game Loop
        let lastTime = Date.now();
        state.loop = setInterval(() => {
            const now = Date.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;
            
            state.currentTime -= dt;
            if (state.currentTime <= 0) {
                state.currentTime = 0;
                endGame();
            }
            renderTimer(state.currentTime);
            
            // Combo Bar Logic
            if (state.combo > 0) {
                let windowTime = (state.combo > 50) ? 0.5 : 1.0; // Áßí
                let elapsed = (now - state.lastTapTime) / 1000;
                let ratio = Math.max(0, 1 - (elapsed / windowTime));
                document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(${ratio})`;
                
                if (ratio <= 0) state.combo = 0;
            } else {
                 document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(0)`;
            }

        }, 50); // 20FPS update logic
    }

    function endGame() {
        state.isPlaying = false;
        clearInterval(state.loop);
        toggleBGM(false);
        
        // Show Result or Input Name
        if (!playerName) {
            document.getElementById('ui-input-screen').style.display = 'block';
        } else {
            showResultScreen();
        }
    }

    // --- 5. UI ÊµÅÁ®ãÊéßÂà∂ ---

    async function startCountdownSequence() {
        document.getElementById('ui-home-screen').style.display = 'none';
        document.getElementById('ui-result-screen').style.display = 'none';
        
        const seq = ['ui-text-3', 'ui-text-2', 'ui-text-1', 'ui-text-go'];
        for (let id of seq) {
            const el = document.getElementById(id);
            el.style.display = 'block';
            el.classList.add('anim-pop');
            playSnd('hit'); // Count sound
            await new Promise(r => setTimeout(r, 600));
            el.style.display = 'none';
            el.classList.remove('anim-pop');
        }
        
        startGame();
        toggleBGM(true);
    }

    // ÊåâÈàïÁ∂ÅÂÆö
    function setupBtn(id, callback) {
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('touchstart', (e) => {
            e.preventDefault();
            el.classList.add('btn-pressed');
        });
        el.addEventListener('touchend', () => {
            el.classList.remove('btn-pressed');
            callback();
        });
        el.addEventListener('mousedown', () => el.classList.add('btn-pressed'));
        el.addEventListener('mouseup', () => {
            el.classList.remove('btn-pressed');
            callback();
        });
    }

    setupBtn('btn-start', () => { initAudio(); startCountdownSequence(); });
    setupBtn('res-btn-retry', () => { startCountdownSequence(); });
    setupBtn('btn-confirm-name', () => {
        const val = document.getElementById('ui-input-field').value.trim();
        if(val) {
            playerName = val.substring(0,8);
            localStorage.setItem('pixelJD_Player', playerName);
            document.getElementById('ui-input-screen').style.display = 'none';
            showResultScreen();
        }
    });

    // Grid ÈªûÊìäÁ∂ÅÂÆö
    document.querySelectorAll('.card-slot').forEach((slot, index) => {
        const h = (e) => {
            e.preventDefault(); // Èò≤Ê≠¢ÈõôÊìäÁ∏ÆÊîæ
            slot.classList.add('pressed');
            handleTap(index);
            setTimeout(() => slot.classList.remove('pressed'), 100);
        };
        slot.addEventListener('touchstart', h, {passive: false});
        slot.addEventListener('mousedown', h);
    });

    // --- 6. ÊéíË°åÊ¶ú (Firebase) ---
    async function showResultScreen() {
        document.getElementById('ui-result-screen').style.display = 'block';
        document.getElementById('my-rank-name').innerText = playerName;
        
        // Upload Score
        if (playerName) {
            const ref = doc(db, "leaderboard", playerName);
            try {
                const snap = await getDoc(ref);
                if (!snap.exists() || state.score > snap.data().score) {
                    await setDoc(ref, { name: playerName, score: state.score, rounds: state.rounds, ts: Date.now() });
                }
            } catch(e) { console.error(e); }
        }

        // Render My Score
        const myScoreCon = document.getElementById('my-rank-score-container');
        myScoreCon.innerHTML = '';
        state.score.toString().padStart(8, '0').split('').forEach(c => {
             const img = document.createElement('img');
             img.src = `assets/num_grid_${c}.webp`;
             img.className = 'rank-score-digit';
             myScoreCon.appendChild(img);
        });
    }

    // Áõ£ËÅΩÊéíË°åÊ¶ú
    const q = query(scoresCol, orderBy("score", "desc"), limit(50));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById('rank-scroll-view');
        if(!list) return;
        list.innerHTML = '';
        let i = 1;
        snapshot.forEach(doc => {
            const data = doc.data();
            const row = document.createElement('div');
            row.className = 'rank-row';
            
            // Âª∫Á´ãÂàÜÊï∏ÂúñÁâá HTML
            let scoreHtml = '';
            (data.score||0).toString().padStart(8,'0').split('').forEach(c => {
                scoreHtml += `<img src="assets/num_grid_${c}.webp" class="rank-score-digit">`;
            });

            row.innerHTML = `
                <span class="rank-num">${i}</span>
                <span class="rank-name">${data.name}</span>
                <span class="rank-flag">üáπüáº</span>
                <div class="rank-score">${scoreHtml}</div>
            `;
            list.appendChild(row);
            i++;
        });
    });

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel JD - Bear Flash Tap Master</title>
    <style>
        /* --- åŸºç¤ç’°å¢ƒè¨­å®š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; font-family: sans-serif; }
        
        #game-container { 
            width: 720px; height: 1280px; 
            position: relative; overflow: hidden; 
            background: #1a1a2e; 
            transform-origin: center; flex-shrink: 0; 
            touch-action: none; 
        }
        
        .ui-element { position: absolute; transform: translate(-50%, -50%); transform-origin: center; user-select: none; -webkit-user-drag: none; }

        /* --- 1. èƒŒæ™¯èˆ‡è§’è‰² --- */
        #bg-main { width: 720px; height: 1280px; left: 360px; top: 640px; z-index: 0; }
        
        /* [ä¿®æ­£] èƒŒæ™¯é–ƒé›» VFX - ç§»é™¤æ··åˆæ¨¡å¼ï¼Œé‚„åŸçœŸå¯¦è‰²å½© */
        .vfx-thunder {
            width: 244px;
            height: 234px;
            z-index: 1; 
            pointer-events: none;
            
            /* å¸¸é§é¡¯ç¤º */
            opacity: 1; 
            
            /* [é‡è¦ä¿®æ­£] ç§»é™¤ mix-blend-mode: screen; è®“åœ–ç‰‡é¡¯ç¤ºåŸè‰² */
            /* mix-blend-mode: screen; */ 
        }

        /* å·¦é‚Šé–ƒé›» (5ç§’é–ƒçˆä¸€æ¬¡) */
        #vfx-thunder-left {
            left: 11px;
            top: 291px;
            transform: translate(-50%, -50%) scaleX(-1);
            animation: thunder-flicker-off 5s infinite; 
        }

        /* å³é‚Šé–ƒé›» (7ç§’é–ƒçˆä¸€æ¬¡) */
        #vfx-thunder-right {
            left: 711px;
            top: 293px;
            transform: translate(-50%, -50%);
            animation: thunder-flicker-off 7s infinite 2s; /* éŒ¯é–‹æ™‚é–“ */
        }

        /* åå‘é–ƒçˆå‹•ç•«ï¼šäº® -> æš— -> äº® */
        @keyframes thunder-flicker-off {
            0%, 90% { opacity: 1; }   /* 90%çš„æ™‚é–“éƒ½æ˜¯äº®çš„ */
            91% { opacity: 0; }       /* ç¬é–“æ–·é›» */
            92% { opacity: 1; }       /* å›å¾© */
            93% { opacity: 0.2; }     /* é›»å£“ä¸ç©© */
            94% { opacity: 1; }       /* å›å¾© */
            95% { opacity: 0.5; }     /* å¾®æš— */
            100% { opacity: 1; }      /* å›åˆ°ç©©å®šäº® */
        }

        #ui-character-bear { width: 496px; height: 612px; left: 360px; top: 460px; z-index: 2; }
        #ui-panel-main { width: 720px; height: 810px; left: 360px; top: 875px; z-index: 5; }
        
        /* --- 2. â³ è¨ˆæ™‚å™¨å®¹å™¨ --- */
        #ui-timer-container {
            position: absolute; left: 360px; top: 98px; width: 300px; height: 80px;
            transform: translate(-50%, -50%) scale(1.2); z-index: 30;
            display: flex; justify-content: center; align-items: center; gap: 0; pointer-events: none;
        }
        .timer-digit { height: 100%; width: 50px; object-fit: contain; margin: 0 -3px; }
        .timer-colon-slot { height: 60%; width: 30px; object-fit: contain; margin-top: -5px; }

        /* --- 3. éŠæˆ²æ ¸å¿ƒ UI --- */
        #ui-text-combo-time { width: 189px; height: 32px; left: 129px; top: 501px; z-index: 10; }
        #ui-combo-bar-bg { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 10; }
        #ui-combo-bar-fill { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 11; transform-origin: left; transform: translate(-50%, -50%) scaleX(1); transition: transform 0.3s ease-out; cursor: pointer; }
        #ui-combo-bar-cover { width: 25px; height: 26px; left: 237px; top: 501px; z-index: 12; pointer-events: none; }
        
        /* éŠæˆ²ä¸­ç©åˆ†é¡¯ç¤º */
        #ui-game-score {
            position: absolute; left: 402px; width: 300px; top: 100px; transform: translateY(-50%);
            display: flex; justify-content: flex-end; color: rgb(51, 206, 15); font-size: 33px; 
            font-family: monospace; font-style: italic; font-weight: 900; text-shadow: 2px 2px 0px rgba(0,0,0,0.5); z-index: 30; pointer-events: none;
        }

        /* HIT ç‰¹æ•ˆå®¹å™¨ */
        .hit-effect-wrapper {
            position: absolute; 
            display: flex; flex-direction: row; align-items: center; justify-content: center;
            gap: 5px; pointer-events: none; z-index: 150;
            transform: translate(-50%, -50%);
            /* å‹•ç•«ï¼šæ™‚é–“1.5sï¼Œé•·è·é›¢é£›è¡Œ */
            animation: hit-float 1.5s cubic-bezier(0.1, 0.8, 0.2, 1) forwards;
        }

        .hit-num-digit { height: 40px; width: auto; object-fit: contain; margin: 0 -2px; }
        .hit-text-img { width: 74px; height: 38px; object-fit: contain; margin-left: 5px; }

        /* é•·è·é›¢é£›è¡Œå‹•ç•« */
        @keyframes hit-float {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            10% { transform: translate(-50%, -150%) scale(1.3); opacity: 1; } 
            100% { transform: translate(-50%, -450%) scale(1.0); opacity: 0; } 
        }

        /* ä¹å®®æ ¼æŒ‰éˆ• */
        #game-grid { position: absolute; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .card-slot { 
            position: absolute; width: 230px; height: 230px; 
            transform: translate(-50%, -50%); 
            pointer-events: auto; cursor: pointer; 
            transition: transform 0.08s cubic-bezier(0.1, 0.7, 1.0, 0.1); 
            touch-action: manipulation; 
        }
        .card-slot.pressed { transform: translate(-50%, -50%) scale(0.92) !important; filter: brightness(0.9); }
        .btn-card-base { width: 100%; height: 100%; display: block; }
        .num-wrapper { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; gap: -10px; pointer-events: none; width: 100%; }
        .num-wrapper img { width: 121px; height: 134px; flex-shrink: 0; }

        /* æ˜Ÿæ˜Ÿç²’å­ç‰¹æ•ˆ */
        .particle-star {
            position: absolute; width: 44px; height: 44px; pointer-events: none; z-index: 99; 
            transform-origin: center; 
            transition: transform 0.8s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.8s ease-in; 
            opacity: 1;
        }

        /* HUD Icons */
        .hud-item { z-index: 15; transition: opacity 0.2s; }
        #ui-heart-1 { width: 44px; height: 38px; left: 53px; top: 100px; }
        #ui-heart-2 { width: 44px; height: 38px; left: 101px; top: 100px; }
        #ui-heart-3 { width: 44px; height: 38px; left: 149px; top: 100px; }
        #ui-icon-star { width: 44px; height: 44px; left: 528px; top: 99px; z-index: 15; }

        /* --- 4. å€’æ•¸å‹•ç•« --- */
        .countdown-img { z-index: 50; display: none; pointer-events: none; }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; }
        }
        .anim-pop { animation: popIn 0.5s ease-out forwards; }
        #ui-text-3 { width: 167px; height: 211px; left: 358px; top: 757px; }
        #ui-text-2 { width: 169px; height: 211px; left: 356px; top: 757px; }
        #ui-text-1 { width: 101px; height: 212px; left: 355px; top: 757px; }
        #ui-text-go { width: 343px; height: 185px; left: 357px; top: 757px; }

        /* --- 5. é¦–é åœ–å±¤ --- */
        #ui-home-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 100; }
        #ui-mask { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.5); cursor: pointer; }
        #ui-panel-start { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 101; }
        #character-home { width: 547px; height: 496px; left: 361px; top: 676px; z-index: 102; }
        #logo-main { width: 514px; height: 216px; left: 369px; top: 315px; z-index: 102; }
        
        #btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; z-index: 103; cursor: pointer; transition: transform 0.1s; touch-action: manipulation; }
        #btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; z-index: 103; cursor: pointer; transition: transform 0.1s; touch-action: manipulation; }
        #btn-start { width: 522px; height: 101px; left: 360px; top: 981px; z-index: 103; cursor: pointer; transition: transform 0.1s; touch-action: manipulation; }
        
        .btn-pressed { transform: translate(-50%, -50%) scale(0.95) !important; filter: brightness(0.9); }
        
        #ui-text-start { width: 364px; height: 56px; left: 362px; top: 985px; z-index: 104; pointer-events: none; transition: transform 0.1s; }
        #btn-start.pressed ~ #ui-text-start { transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9); }

        /* --- 6. ğŸ† çµç®—ä»‹é¢ --- */
        #ui-result-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 200; display: none; }
        #res-panel { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 201; }
        #res-panel-rank { width: 547px; height: 653px; left: 361px; top: 598px; z-index: 202; }
        
        /* æ¨™é¡Œ Logo */
        #logo-rank-title { width: 378px; height: 162px; left: 360px; top: 184px; z-index: 205; }

        /* é®ç½©å±¤ */
        #rank-content-layer {
            position: absolute; left: 361px; top: 598px; 
            width: 540px; 
            height: 600px; 
            border-radius: 30px; overflow: hidden; transform: translate(-50%, -50%); z-index: 203;
        }
        
        #rank-scroll-view {
            width: 100%; height: 100%; overflow-y: scroll; -webkit-overflow-scrolling: touch;
            scrollbar-width: none; -ms-overflow-style: none; 
            display: flex; flex-direction: column; align-items: center;
            padding-top: 10px; 
            padding-bottom: 120px; 
        }
        #rank-scroll-view::-webkit-scrollbar { display: none; }

        /* [æ’è¡Œæ¦œ çµ•å°åº§æ¨™å°ä½] */
        .rank-row {
            width: 522px; 
            height: 101px; 
            margin-bottom: -2px; 
            background-image: url('assets/ui_rank_row_normal.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            flex-shrink: 0; position: relative; 
            font-weight: 900; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }

        .rank-num {
            position: absolute; left: 20px; width: 82px; top: 50%; transform: translateY(-50%);
            text-align: left; color: rgb(255, 222, 0); font-size: 40px; font-style: normal; white-space: nowrap; 
        }

        .rank-name {
            position: absolute; left: 106px; width: 152px; top: 50%; transform: translateY(-50%);
            text-align: left; color: rgb(255, 255, 255); font-size: 28px; white-space: nowrap; overflow: hidden;
        }

        .rank-flag {
            position: absolute; left: 260px; top: 50%; transform: translateY(-50%);
            font-size: 28px; font-style: normal; text-shadow: none; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5)); z-index: 2; 
        }

        .rank-score {
            position: absolute; left: 258px; width: 240px; top: 50%; transform: translateY(-50%);
            display: flex; justify-content: flex-end; align-items: center;
            color: rgb(51, 206, 15); font-size: 40px; font-family: monospace; font-style: italic;
        }

        /* C. å›ºå®šåº•éƒ¨ (è‡ªå·±) */
        #rank-fixed-row {
            position: absolute; left: 360px; top: 855px; width: 522px; height: 101px;
            transform: translate(-50%, -50%); z-index: 205; 
            background-image: url('assets/ui_rank_row_self.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            font-weight: 900; text-shadow: 2px 2px 0px rgba(0,0,0,0.5); pointer-events: none;
        }

        #res-btn-coffee, #res-btn-share, #res-btn-retry { z-index: 203; cursor: pointer; touch-action: manipulation; }
        #res-btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; }
        #res-btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; }
        #res-btn-retry { width: 522px; height: 101px; left: 360px; top: 981px; }
        #ui-text-retry { width: 323px; height: 55px; left: 362px; top: 985px; z-index: 204; pointer-events: none; transition: transform 0.1s; }
        #res-btn-retry.pressed ~ #ui-text-retry { transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9); }

        #bg-bar-top { width: 720px; height: 53px; left: 360px; top: 27px; z-index: 20; }
        #bg-bar-bottom { width: 720px; height: 69px; left: 360px; top: 1246px; z-index: 20; }

        /* Debug é¢æ¿ */
        #debug-panel { position: fixed; top: 10px; right: 10px; z-index: 999; background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; width: 210px; font-family: monospace; }
        .debug-group { margin-bottom: 12px; border-bottom: 1px solid #444; padding-bottom: 8px; }
        .debug-group label { display: block; font-size: 11px; color: #ffeb3b; margin-bottom: 5px; }
        .debug-btn { background: #444; color: #fff; border: 1px solid #666; padding: 4px; margin: 2px; cursor: pointer; border-radius: 4px; font-size: 10px; width: 45%; }
    </style>
</head>
<body>

<div id="game-container">
    <img src="assets/bg_main.webp" class="ui-element" id="bg-main">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-left">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-right">
    <img src="assets/character_bear.webp" class="ui-element" id="ui-character-bear">
    <img src="assets/panel_main.webp" class="ui-element" id="ui-panel-main">

    <div id="ui-timer-container">
        <img id="timer-d1" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d2" class="timer-digit" src="assets/num_ui_6.webp">
        <img class="timer-colon-slot" src="assets/num_ui_colon.webp">
        <img id="timer-d3" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d4" class="timer-digit" src="assets/num_ui_0.webp">
    </div>

    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-1">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-2">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-3">
    <img src="assets/icon_star.webp" class="ui-element" id="ui-icon-star">
    <div id="ui-game-score">00000000</div>

    <div id="game-grid">
        <div class="card-slot" style="left: 130px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_1.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_2.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_3.webp"></div></div>
        <div class="card-slot" style="left: 130px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_4.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_5.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_6.webp"></div></div>
        <div class="card-slot" style="left: 130px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_7.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_8.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_9.webp"></div></div>
    </div>

    <img src="assets/ui_text_3.webp" class="ui-element countdown-img" id="ui-text-3">
    <img src="assets/ui_text_2.webp" class="ui-element countdown-img" id="ui-text-2">
    <img src="assets/ui_text_1.webp" class="ui-element countdown-img" id="ui-text-1">
    <img src="assets/ui_text_go.webp" class="ui-element countdown-img" id="ui-text-go">

    <div id="ui-home-screen">
        <div id="ui-mask" onclick="this.parentElement.style.display='none'"></div>
        <img src="assets/ui_panel_start.webp" class="ui-element" id="ui-panel-start">
        <img src="assets/character_home.webp" class="ui-element" id="character-home">
        <img src="assets/logo_main.webp" class="ui-element" id="logo-main">
        <img src="assets/btn_coffee.webp" class="ui-element" id="btn-coffee" onclick="alert('Support Button!')">
        <img src="assets/btn_share.webp" class="ui-element" id="btn-share" onclick="alert('Share Button!')">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-start" onclick="startGameProcess()">
        <img src="assets/ui_text_start.webp" class="ui-element" id="ui-text-start">
    </div>

    <div id="ui-result-screen">
        <div id="ui-mask-result" style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);" onclick="this.parentElement.style.display='none'"></div>
        
        <img src="assets/logo_rank_title.webp" class="ui-element" id="logo-rank-title">

        <img src="assets/ui_panel_start.webp" class="ui-element" id="res-panel">
        <img src="assets/ui_panel_rank.webp" class="ui-element" id="res-panel-rank"> 
        
        <div id="rank-content-layer">
            <div id="rank-scroll-view"></div>
        </div>

        <div id="rank-fixed-row">
            <span class="rank-num">6</span>
            <span class="rank-name">YOU</span>
            <span class="rank-flag">ğŸ‡¹ğŸ‡¼</span>
            <span class="rank-score">00012345</span>
        </div>
        
        <img src="assets/btn_coffee.webp" class="ui-element" id="res-btn-coffee">
        <img src="assets/btn_share.webp" class="ui-element" id="res-btn-share">
        <img src="assets/btn_start.webp" class="ui-element" id="res-btn-retry" onclick="alert('Replay Logic Here')">
        <img src="assets/ui_text_retry.webp" class="ui-element" id="ui-text-retry">
    </div>

    <img src="assets/bg_bar_top.webp" class="ui-element" id="bg-bar-top">
    <img src="assets/bg_bar_bottom.webp" class="ui-element" id="bg-bar-bottom">
</div>

<div id="debug-panel">
    <div class="debug-group">
        <label>ç•«é¢æ¸¬è©¦</label>
        <button class="debug-btn" onclick="showResultScreen()" style="background:#f57c00; border-color:#ffb74d;">ğŸ’€ é¡¯ç¤ºçµç®—ä»‹é¢</button>
    </div>
    <div class="debug-group">
        <label>éŠæˆ²æµç¨‹</label>
        <button class="debug-btn btn-play" onclick="startGameProcess()">â–¶ æ¸¬è©¦å€’æ•¸</button>
        <button class="debug-btn" onclick="stopGameTimer()">â¹ åœæ­¢è¨ˆæ™‚</button>
    </div>
    <div class="debug-group">
        <label>æ•¸å­—ç¸®æ”¾</label>
        <button class="debug-btn" onclick="testDigits(2)">2ä½</button>
        <button class="debug-btn" onclick="testDigits(5)">5ä½</button>
    </div>
    <div class="debug-group">
        <label>HP / Bar æ¸¬è©¦</label>
        <button class="debug-btn" onclick="testHP(1)">1 HP</button>
        <button class="debug-btn" onclick="testHP(3)">å…¨æ»¿</button>
        <input type="range" id="debug-slider" min="0" max="100" value="100" oninput="testBar(this.value)" style="width:95%; margin-top:5px;">
    </div>
    <button class="debug-btn" style="width:100%; background:#c62828;" onclick="this.parentElement.style.display='none'">éš±è—é¢æ¿</button>
</div>

<script>
    let gameTimer = null;
    let timeLeft = 6000;
    let comboCount = 0;

    const timerEls = {
        d1: document.getElementById('timer-d1'),
        d2: document.getElementById('timer-d2'),
        d3: document.getElementById('timer-d3'),
        d4: document.getElementById('timer-d4')
    };

    function resizeGame() {
        const container = document.getElementById('game-container');
        const scale = Math.min(window.innerWidth / 720, window.innerHeight / 1280);
        container.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame);
    window.addEventListener('load', () => {
        resizeGame();
        preloadGameAssets();
    });

    function preloadGameAssets() {
        const assets = [
            'num_ui_0.webp', 'num_ui_1.webp', 'num_ui_2.webp', 'num_ui_3.webp', 'num_ui_4.webp',
            'num_ui_5.webp', 'num_ui_6.webp', 'num_ui_7.webp', 'num_ui_8.webp', 'num_ui_9.webp', 'num_ui_colon.webp',
            'num_grid_0.webp', 'num_grid_1.webp', 'num_grid_2.webp', 'num_grid_3.webp', 'num_grid_4.webp',
            'num_grid_5.webp', 'num_grid_6.webp', 'num_grid_7.webp', 'num_grid_8.webp', 'num_grid_9.webp',
            'ui_rank_row_normal.webp', 'ui_rank_row_self.webp', 'logo_rank_title.webp',
            'icon_star.webp', 
            'vfx_thunder.webp',
            'ui_text_hit.webp'
        ];
        assets.forEach(name => {
            const img = new Image();
            img.src = 'assets/' + name;
        });
        console.log("Assets preloading started...");
    }

    function createStarBurst(x, y) {
        const container = document.getElementById('game-container');
        const count = Math.floor(Math.random() * 3) + 4; 

        for (let i = 0; i < count; i++) {
            const star = document.createElement('img');
            star.src = 'assets/icon_star.webp';
            star.className = 'particle-star';

            // å·¨å¤§åŒ–æ˜Ÿæ˜Ÿ
            const size = Math.random() * 40 + 80; 
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;

            star.style.left = `${x}px`;
            star.style.top = `${y}px`;
            star.style.transform = `translate(-50%, -50%) scale(0.5)`;

            const angle = Math.random() * Math.PI * 2; 
            // å™´ç™¼åŠ›é“
            const velocity = Math.random() * 150 + 100; 
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;
            const rot = Math.random() * 720; 

            container.appendChild(star);

            requestAnimationFrame(() => {
                star.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(0) rotate(${rot}deg)`;
                star.style.opacity = '0';
            });

            setTimeout(() => {
                star.remove();
            }, 800); // æ˜Ÿæ˜Ÿæ™‚é–“ 0.8s
        }
    }

    // ç”¢ç”Ÿ HIT æ•¸å€¼ç‰¹æ•ˆ
    function createHitEffect(x, y, comboVal) {
        const container = document.getElementById('game-container');
        const wrapper = document.createElement('div');
        wrapper.className = 'hit-effect-wrapper';
        wrapper.style.left = `${x}px`;
        wrapper.style.top = `${y - 50}px`; 

        // 1. ç”¢ç”Ÿæ•¸å­— (åœ¨å·¦é‚Š)
        const valStr = comboVal.toString();
        for (let char of valStr) {
            const digit = document.createElement('img');
            digit.src = `assets/num_ui_${char}.webp`;
            digit.className = 'hit-num-digit';
            wrapper.appendChild(digit);
        }

        // 2. ç”¢ç”Ÿ HIT å­—æ¨£ (åœ¨å³é‚Š)
        const hitImg = document.createElement('img');
        hitImg.src = 'assets/ui_text_hit.webp';
        hitImg.className = 'hit-text-img';
        wrapper.appendChild(hitImg);

        container.appendChild(wrapper);

        // å»¶é•·åˆ° 1.5s ç§»é™¤
        setTimeout(() => {
            wrapper.remove();
        }, 1500); 
    }

    function initLeaderboard() {
        const list = document.getElementById('rank-scroll-view');
        list.innerHTML = ''; 
        
        const flags = ['ğŸ‡¹ğŸ‡¼', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡°ğŸ‡·', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡«ğŸ‡·', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡¹ğŸ‡­'];

        for(let i=1; i<=100; i++) {
            const row = document.createElement('div');
            row.className = 'rank-row';
            
            const rankStr = i;
            let nameRaw = `Player${i}`;
            const nameStr = nameRaw.substring(0, 8); 
            let scoreRaw = 99999 - i * 100;
            const scoreStr = scoreRaw.toString().padStart(8, '0');
            const flagEmoji = flags[i % flags.length];

            let rankFontSize = '40px'; 
            if (i >= 1000) rankFontSize = '32px'; 
            if (i >= 10000) rankFontSize = '26px'; 

            row.innerHTML = `
                <span class="rank-num" style="font-size:${rankFontSize}">${rankStr}</span>
                <span class="rank-name">${nameStr}</span>
                <span class="rank-flag">${flagEmoji}</span>
                <span class="rank-score">${scoreStr}</span>
            `;
            list.appendChild(row);
        }
    }
    initLeaderboard(); 

    function setupButtonFeedback(element, isCard = false) {
        if (!element) return;
        const pressClass = isCard ? 'pressed' : 'btn-pressed';
        element.addEventListener('pointerdown', (e) => {
            element.classList.add(pressClass);
            element.setPointerCapture(e.pointerId);

            if (isCard) {
                const cx = parseInt(element.style.left);
                const cy = parseInt(element.style.top);
                
                // è§¸ç™¼æ˜Ÿæ˜Ÿ
                createStarBurst(cx, cy);
                
                // è§¸ç™¼ Combo é¡¯ç¤º
                comboCount++; 
                createHitEffect(cx, cy, comboCount);
            }
        });
        const release = () => { element.classList.remove(pressClass); };
        element.addEventListener('pointerup', release);
        element.addEventListener('pointerleave', release);
        element.addEventListener('pointercancel', release);
    }

    document.querySelectorAll('.card-slot').forEach(slot => { setupButtonFeedback(slot, true); });
    setupButtonFeedback(document.getElementById('btn-start'));
    setupButtonFeedback(document.getElementById('btn-coffee'));
    setupButtonFeedback(document.getElementById('btn-share'));
    setupButtonFeedback(document.getElementById('res-btn-retry'));
    setupButtonFeedback(document.getElementById('res-btn-coffee'));
    setupButtonFeedback(document.getElementById('res-btn-share'));

    function showResultScreen() {
        document.getElementById('ui-result-screen').style.display = 'block';
    }

    function updateTimerDisplay(totalUnits) {
        const seconds = Math.floor(totalUnits / 100);
        const millis = totalUnits % 100;
        const sStr = seconds.toString().padStart(2, '0');
        const mStr = millis.toString().padStart(2, '0');

        if (timerEls.d1.src.indexOf(`num_ui_${sStr[0]}.webp`) === -1) 
            timerEls.d1.src = `assets/num_ui_${sStr[0]}.webp`;
        if (timerEls.d2.src.indexOf(`num_ui_${sStr[1]}.webp`) === -1) 
            timerEls.d2.src = `assets/num_ui_${sStr[1]}.webp`;
        if (timerEls.d3.src.indexOf(`num_ui_${mStr[0]}.webp`) === -1) 
            timerEls.d3.src = `assets/num_ui_${mStr[0]}.webp`;
        if (timerEls.d4.src.indexOf(`num_ui_${mStr[1]}.webp`) === -1) 
            timerEls.d4.src = `assets/num_ui_${mStr[1]}.webp`;
    }

    function startGameTimer() {
        stopGameTimer();
        timeLeft = 6000;
        comboCount = 0; // é‡ç½® combo
        updateTimerDisplay(timeLeft);
        gameTimer = setInterval(() => {
            timeLeft--;
            if (timeLeft <= 0) {
                timeLeft = 0;
                stopGameTimer();
                alert("Time Up!");
                showResultScreen(); 
            }
            updateTimerDisplay(timeLeft);
        }, 10);
    }

    function stopGameTimer() {
        if (gameTimer) clearInterval(gameTimer);
    }

    function startGameProcess() {
        document.getElementById('ui-home-screen').style.display = 'none';
        document.getElementById('ui-result-screen').style.display = 'none'; 
        
        const ids = ['ui-text-3', 'ui-text-2', 'ui-text-1', 'ui-text-go'];
        let delay = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.style.display = 'none';
            el.classList.remove('anim-pop');
        });
        ids.forEach((id, index) => {
            setTimeout(() => {
                if(index > 0) document.getElementById(ids[index-1]).style.display = 'none';
                const el = document.getElementById(id);
                el.style.display = 'block';
                el.classList.add('anim-pop');
                if (id === 'ui-text-go') {
                    setTimeout(() => { 
                        el.style.display = 'none'; 
                        startGameTimer(); 
                    }, 500);
                }
            }, delay);
            delay += 800;
        });
    }

    function setGridNumber(index, number) {
        const slots = document.querySelectorAll('.card-slot');
        if (!slots[index]) return;
        const wrapper = slots[index].querySelector('.num-wrapper');
        const numStr = number.toString();
        wrapper.innerHTML = '';
        for (let char of numStr) {
            const img = document.createElement('img'); img.src = `assets/num_grid_${char}.webp`;
            wrapper.appendChild(img);
        }
        let scaleValue = 1.0;
        const len = numStr.length;
        if (len === 2) scaleValue = 0.8;
        else if (len === 3) scaleValue = 0.5;
        else if (len === 4) scaleValue = 0.4;
        else if (len >= 5) scaleValue = 0.3;
        wrapper.style.transform = `translate(-50%, -50%) scale(${scaleValue})`;
    }

    document.querySelectorAll('.card-slot').forEach((slot, i) => {
        slot.addEventListener('click', () => setGridNumber(i, Math.floor(Math.random() * 99999) + 1));
    });

    function testDigits(d) {
        const val = Math.pow(10, d) - 1;
        document.querySelectorAll('.card-slot').forEach((_, i) => setGridNumber(i, val));
    }

    function testHP(hp) {
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`ui-heart-${i}`).style.opacity = i <= hp ? "1" : "0.2";
        }
    }

    function testBar(val) {
        document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(${val/100})`;
    }
    const fillBar = document.getElementById('ui-combo-bar-fill');
    fillBar.addEventListener('click', () => { fillBar.style.transform = `translate(-50%, -50%) scaleX(${Math.random()})`; });

    updateTimerDisplay(6000);
</script>
</body>
</html>
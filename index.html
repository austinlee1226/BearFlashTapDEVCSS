<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel JD - Bear Flash Tap Master</title>

    <style>
        /* --- åŸºç¤ç’°å¢ƒè¨­å®š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; font-family: sans-serif; }
        
        #game-container { 
            width: 720px; height: 1280px; 
            position: relative; overflow: hidden; 
            background: #1a1a2e; 
            transform-origin: center; flex-shrink: 0; 
            touch-action: none; 
        }
        
        .ui-element { position: absolute; transform: translate(-50%, -50%); transform-origin: center; user-select: none; -webkit-user-drag: none; }

        /* --- 1. èƒŒæ™¯èˆ‡è§’è‰² --- */
        #bg-main { width: 720px; height: 1280px; left: 360px; top: 640px; z-index: 0; }
        
        /* èƒŒæ™¯é–ƒé›» VFX */
        .vfx-thunder { width: 244px; height: 234px; z-index: 1; pointer-events: none; opacity: 1; }
        #vfx-thunder-left { left: 11px; top: 291px; transform: translate(-50%, -50%) scaleX(-1); animation: thunder-flicker-off 5s infinite; }
        #vfx-thunder-right { left: 711px; top: 293px; transform: translate(-50%, -50%); animation: thunder-flicker-off 7s infinite 2s; }

        @keyframes thunder-flicker-off {
            0%, 92% { opacity: 1; } 93% { opacity: 0; } 94% { opacity: 1; } 95% { opacity: 0.3; } 96% { opacity: 1; } 100% { opacity: 1; }
        }

        /* è§’è‰²è¨­å®š */
        #ui-character-bear, #ui-character-devil { width: 496px; height: 612px; left: 360px; top: 460px; z-index: 2; transition: filter 0.1s; }
        #ui-character-devil { display: none; }

        /* è§’è‰²å‹•ç•« */
        @keyframes anim-shake {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-51%, -50%) rotate(-1deg); } 
            50% { transform: translate(-49%, -50%) rotate(1deg); }  
            75% { transform: translate(-50.5%, -50%) rotate(-0.5deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        .effect-shake { animation: anim-shake 0.15s ease-in-out; }

        @keyframes anim-sink {
            0% { transform: translate(-50%, -50%); opacity: 1; filter: grayscale(0); }
            20% { transform: translate(-50%, -50%); opacity: 1; filter: grayscale(1); }
            100% { transform: translate(-50%, -20%); opacity: 0; filter: grayscale(1); }
        }
        .effect-sink { animation: anim-sink 1.0s ease-in forwards; }

        @keyframes anim-rise {
            0% { transform: translate(-50%, -20%); opacity: 0; }
            100% { transform: translate(-50%, -50%); opacity: 1; }
        }
        .effect-rise { display: block !important; animation: anim-rise 0.8s ease-out forwards; }

        #ui-panel-main { width: 720px; height: 810px; left: 360px; top: 875px; z-index: 5; }
        
        /* --- 2. â³ è¨ˆæ™‚å™¨å®¹å™¨ --- */
        #ui-timer-container {
            position: absolute; left: 360px; top: 98px; width: 300px; height: 80px;
            transform: translate(-50%, -50%) scale(1.2); z-index: 30;
            display: flex; justify-content: center; align-items: center; gap: 0; pointer-events: none;
        }
        .timer-digit { height: 100%; width: 50px; object-fit: contain; margin: 0 -3px; }
        .timer-colon-slot { height: 60%; width: 30px; object-fit: contain; margin-top: -5px; }

        /* --- 3. éŠæˆ²æ ¸å¿ƒ UI --- */
        #ui-text-combo-time { width: 189px; height: 32px; left: 129px; top: 501px; z-index: 20; }
        #ui-combo-bar-bg { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 20; }
        #ui-combo-bar-fill { width: 451px; height: 26px; left: 460px; top: 501px; z-index: 21; transform-origin: left; transform: translate(-50%, -50%) scaleX(1); transition: transform 0.3s ease-out; cursor: pointer; }
        #ui-combo-bar-cover { width: 25px; height: 26px; left: 237px; top: 501px; z-index: 22; pointer-events: none; }
        
        #ui-game-score {
            position: absolute; left: 402px; width: 300px; top: 100px; transform: translateY(-50%);
            display: flex; justify-content: flex-end; align-items: center; z-index: 30; pointer-events: none; gap: 1px;
        }
        .score-digit-img { height: 22px; width: auto; object-fit: contain; }

        /* HIT ç‰¹æ•ˆå®¹å™¨ */
        .hit-effect-wrapper {
            position: absolute; display: flex; flex-direction: row; align-items: center; justify-content: center;
            gap: 5px; pointer-events: none; 
            z-index: 999; /* æœ€ä¸Šå±¤ */
            transform: translate(-50%, -50%);
            animation: hit-float 1.5s cubic-bezier(0.1, 0.8, 0.2, 1) forwards;
        }
        .hit-num-digit { height: 40px; width: auto; object-fit: contain; margin: 0 -10px; }
        .hit-text-img { width: 74px; height: 38px; object-fit: contain; margin-left: 5px; }

        @keyframes hit-float {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            10% { transform: translate(-50%, -150%) scale(1.3); opacity: 1; } 
            100% { transform: translate(-50%, -450%) scale(1.0); opacity: 0; } 
        }

        /* ä¹å®®æ ¼æŒ‰éˆ• */
        #game-grid { position: absolute; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .card-slot { 
            position: absolute; width: 230px; height: 230px; transform: translate(-50%, -50%); 
            pointer-events: auto; cursor: pointer; transition: transform 0.08s cubic-bezier(0.1, 0.7, 1.0, 0.1); touch-action: manipulation; 
        }
        .card-slot.pressed { transform: translate(-50%, -50%) scale(0.92) !important; filter: brightness(0.9); }
        .btn-card-base { width: 100%; height: 100%; display: block; }
        
        /* ã€ä¿®æ­£ç¢ºèªã€‘é€™è£¡ç¾åœ¨æ˜¯å®Œå…¨çš„åŸåœ–å°ºå¯¸ */
        .num-wrapper { 
            position: absolute; left: 50%; top: 50%; 
            transform: translate(-50%, -50%); 
            display: flex; justify-content: center; align-items: center; 
            pointer-events: none; width: 100%; 
        }
        .num-wrapper img { 
            height: auto;  /* ä¿®æ­£ï¼šè‡ªå‹•é«˜åº¦ */
            width: auto;   /* ä¿®æ­£ï¼šè‡ªå‹•å¯¬åº¦ */
            object-fit: contain;
            margin: 0;     
            flex-shrink: 0;
        }

        /* æ˜Ÿæ˜Ÿç²’å­ç‰¹æ•ˆ */
        .particle-star { 
            position: absolute; width: 44px; height: 44px; pointer-events: none; 
            z-index: 999; /* æœ€ä¸Šå±¤ */
            transform-origin: center; transition: transform 0.8s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.8s ease-in; opacity: 1; 
        }

        .hud-item { z-index: 15; transition: opacity 0.2s; }
        #ui-heart-1 { width: 44px; height: 38px; left: 53px; top: 100px; }
        #ui-heart-2 { width: 44px; height: 38px; left: 101px; top: 100px; }
        #ui-heart-3 { width: 44px; height: 38px; left: 149px; top: 100px; }
        #ui-icon-star { width: 44px; height: 44px; left: 528px; top: 99px; z-index: 15; }

        .countdown-img { z-index: 50; display: none; pointer-events: none; }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; }
        }
        .anim-pop { animation: popIn 0.5s ease-out forwards; }
        
        /* å€’æ•¸ 321 æ–‡å­— */
        #ui-text-3 { width: 167px; height: 211px; left: 358px; top: 757px; }
        #ui-text-2 { width: 169px; height: 211px; left: 356px; top: 757px; }
        #ui-text-1 { width: 101px; height: 212px; left: 355px; top: 757px; }
        #ui-text-go { width: 343px; height: 185px; left: 357px; top: 757px; }

        /* éŠæˆ²çµæŸç‹€æ…‹æ–‡å­— */
        .end-text { z-index: 100; display: none; pointer-events: none; }
        .anim-pop-end { animation: popIn 0.5s ease-out forwards; display: block !important; }
        #ui-text-gameover { width: 396px; height: 217px; left: 350px; top: 770px; } 
        #ui-text-timeup { width: 385px; height: 215px; left: 363px; top: 770px; }   

        /* --- 5. é¦–é åœ–å±¤ --- */
        #ui-home-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 100; }
        #ui-mask { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.5); cursor: pointer; }
        #ui-panel-start { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 101; }
        #character-home { width: 547px; height: 496px; left: 361px; top: 676px; z-index: 102; }
        #logo-main { width: 514px; height: 216px; left: 369px; top: 315px; z-index: 102; }
        
        #btn-coffee, #btn-share, #btn-start { z-index: 103; cursor: pointer; transition: transform 0.1s; touch-action: manipulation; }
        #btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; }
        #btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; }
        #btn-start { width: 522px; height: 101px; left: 360px; top: 981px; }
        
        .btn-pressed { transform: translate(-50%, -50%) scale(0.95) !important; filter: brightness(0.9); }
        #ui-text-start { width: 364px; height: 56px; left: 362px; top: 985px; z-index: 104; pointer-events: none; transition: transform 0.1s; }
        #btn-start.pressed ~ #ui-text-start { transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9); }

        /* --- è¼¸å…¥ä»‹é¢ --- */
        #ui-input-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 180; display: none; }
        #ui-panel-input { width: 540px; height: 240px; left: 360px; top: 600px; z-index: 181; }
        #ui-input-field {
            position: absolute; left: 362px; top: 640px; transform: translate(-50%, -50%);
            width: 320px; height: 60px; z-index: 182;
            background: transparent; border: none; outline: none;
            color: #fff; font-size: 36px; font-weight: 900; text-align: center;
            font-family: monospace; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        #ui-input-field::placeholder { color: rgba(255,255,255,0.3); }
        #btn-confirm-name { width: 522px; height: 101px; left: 360px; top: 800px; z-index: 182; cursor: pointer; }

        /* --- 6. ğŸ† çµç®—ä»‹é¢ --- */
        #ui-result-screen { position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 200; display: none; }
        #res-panel { width: 617px; height: 998px; left: 360px; top: 659px; z-index: 201; }
        #res-panel-rank { width: 547px; height: 653px; left: 361px; top: 598px; z-index: 202; }
        #logo-rank-title { width: 378px; height: 162px; left: 360px; top: 184px; z-index: 205; }

        #rank-content-layer {
            position: absolute; left: 361px; top: 598px; width: 540px; height: 600px; 
            border-radius: 30px; overflow: hidden; transform: translate(-50%, -50%); z-index: 203;
        }
        #rank-scroll-view {
            width: 100%; height: 100%; overflow-y: scroll; -webkit-overflow-scrolling: touch;
            scrollbar-width: none; -ms-overflow-style: none; 
            display: flex; flex-direction: column; align-items: center;
            padding-top: 10px; padding-bottom: 120px; 
        }
        #rank-scroll-view::-webkit-scrollbar { display: none; }

        .rank-row {
            width: 522px; height: 101px; margin-bottom: -2px; 
            background-image: url('assets/ui_rank_row_normal.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            flex-shrink: 0; position: relative; 
            font-weight: 900; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        .rank-num { position: absolute; left: 20px; width: 82px; top: 50%; transform: translateY(-50%); text-align: left; color: rgb(255, 222, 0); font-size: 40px; font-style: normal; white-space: nowrap; }
        .rank-name { position: absolute; left: 106px; width: 152px; top: 50%; transform: translateY(-50%); text-align: left; color: rgb(255, 255, 255); font-size: 28px; white-space: nowrap; overflow: hidden; }
        .rank-flag { position: absolute; left: 260px; top: 50%; transform: translateY(-50%); font-size: 28px; font-style: normal; text-shadow: none; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5)); z-index: 2; }
        .rank-score { position: absolute; left: 258px; width: 240px; top: 50%; transform: translateY(-50%); display: flex; justify-content: flex-end; align-items: center; gap: -2px; }
        .rank-score-digit { height: 28px; width: auto; object-fit: contain; }

        #rank-fixed-row {
            position: absolute; left: 360px; top: 855px; width: 522px; height: 101px;
            transform: translate(-50%, -50%); z-index: 205; 
            background-image: url('assets/ui_rank_row_self.webp');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            font-weight: 900; pointer-events: none;
        }

        #res-btn-coffee { width: 249px; height: 87px; left: 224px; top: 1085px; z-index: 203; cursor: pointer; }
        #res-btn-share { width: 252px; height: 88px; left: 495px; top: 1087px; z-index: 203; cursor: pointer; }
        #res-btn-retry { width: 522px; height: 101px; left: 360px; top: 981px; z-index: 203; cursor: pointer; }
        #ui-text-retry { width: 323px; height: 55px; left: 362px; top: 985px; z-index: 204; pointer-events: none; transition: transform 0.1s; }
        #res-btn-retry.pressed ~ #ui-text-retry { transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9); }

        #bg-bar-top { width: 720px; height: 53px; left: 360px; top: 27px; z-index: 20; }
        #bg-bar-bottom { width: 720px; height: 69px; left: 360px; top: 1246px; z-index: 20; }

        #debug-panel { position: fixed; top: 10px; right: 10px; z-index: 999; background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; width: 210px; font-family: monospace; }
        .debug-group { margin-bottom: 12px; border-bottom: 1px solid #444; padding-bottom: 8px; }
        .debug-group label { display: block; font-size: 11px; color: #ffeb3b; margin-bottom: 5px; }
        .debug-btn { background: #444; color: #fff; border: 1px solid #666; padding: 4px; margin: 2px; cursor: pointer; border-radius: 4px; font-size: 10px; width: 45%; }
 /* --- éŒ¯èª¤åé¥‹ç‰¹æ•ˆ (å»ºè­°è²¼åœ¨ç¬¬240è¡Œä¹‹å‰) --- */

/* å®šç¾©éœ‡å‹•å‹•ç•« */
@keyframes cardShake {
    0%, 100% { transform: translate(-50%, -50%) translateX(0); }
    25% { transform: translate(-50%, -50%) translateX(-8px); }
    75% { transform: translate(-50%, -50%) translateX(8px); }
}

/* å®šç¾©éŒ¯èª¤ç‹€æ…‹ class */
.wrong-flash-card {
    /* 1. å…ˆæŠŠé£½å’Œåº¦é™åˆ° 0 (è®Šç°éš)ï¼Œé€™æ˜¯è®“é¡è‰²è®Šæ·¡è®Šç™½çš„æœ€ç©©åšæ³• */
    /* 2. æ¥è‘—æŠŠäº®åº¦æ‹‰é«˜åˆ° 1.5 ~ 1.8 ä¹‹é–“ (æ·¡ç™½è‰²) */
    /* 3. ç¨å¾®å¢åŠ å°æ¯”åº¦ï¼Œè®“åœ–ç‰‡è¼ªå»“ä¸æ¶ˆå¤± */
    filter: grayscale(1) brightness(1.7) contrast(1.1) !important;
    
    /* ç¢ºä¿åœ–ç‰‡æœ¬èº«å®Œå…¨ä¸é€æ˜ */
    opacity: 1 !important; 
    
    /* ç¶­æŒéœ‡å‹•å‹•ç•« */
    animation: cardShake 0.2s linear;
}
/* è¨ˆæ™‚å™¨è­¦ç¤ºï¼šæ¿¾é¡è®Šç´… */
.timer-danger {
    filter: sepia(1) saturate(10) hue-rotate(-50deg) !important;
}

/* å®šç¾©è·³å‹•å‹•ç•« */
@keyframes timerPulse {
    0% { transform: translate(-50%, -50%) scale(1.2); }
    50% { transform: translate(-50%, -50%) scale(1.4); }
    100% { transform: translate(-50%, -50%) scale(1.2); }
}

/* åŠ ä¸Šé€™å€‹ Class å°±æœƒé–‹å§‹è·³å‹• */
.timer-pulse {
    animation: timerPulse 0.5s infinite;
}
 </style>
</head>
<body>

<div id="game-container">
    <img src="assets/bg_main.webp" class="ui-element" id="bg-main">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-left">
    <img src="assets/vfx_thunder.webp" class="ui-element vfx-thunder" id="vfx-thunder-right">
    
    <img src="assets/character_bear.webp" class="ui-element" id="ui-character-bear">
    <img src="assets/character_bear_devil.webp" class="ui-element" id="ui-character-devil">

    <img src="assets/panel_main.webp" class="ui-element" id="ui-panel-main">

    <div id="ui-timer-container">
        <img id="timer-d1" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d2" class="timer-digit" src="assets/num_ui_1.webp">
        <img class="timer-colon-slot" src="assets/num_ui_colon.webp">
        <img id="timer-d3" class="timer-digit" src="assets/num_ui_0.webp">
        <img id="timer-d4" class="timer-digit" src="assets/num_ui_0.webp">
    </div>

    <audio id="bgm-main" src="assets/bgm_main.mp3" loop preload="auto"></audio>

    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-1">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-2">
    <img src="assets/icon_heart.webp" class="ui-element hud-item" id="ui-heart-3">
    <img src="assets/icon_star.webp" class="ui-element" id="ui-icon-star">
    
    <div id="ui-game-score"></div>

    <img src="assets/ui_text_combo_time.webp" class="ui-element" id="ui-text-combo-time">
    <img src="assets/ui_combo_bar_bg.webp" class="ui-element" id="ui-combo-bar-bg">
    <img src="assets/ui_combo_bar_fill.webp" class="ui-element" id="ui-combo-bar-fill">
    <img src="assets/ui_combo_bar_cover.webp" class="ui-element" id="ui-combo-bar-cover">

    <div id="game-grid">
        <div class="card-slot" style="left: 130px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_1.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_2.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 640px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_3.webp"></div></div>
        <div class="card-slot" style="left: 130px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_4.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_5.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 870px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_6.webp"></div></div>
        <div class="card-slot" style="left: 130px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_7.webp"></div></div>
        <div class="card-slot" style="left: 360px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_8.webp"></div></div>
        <div class="card-slot" style="left: 590px; top: 1100px;"><img src="assets/btn_card_base.webp" class="btn-card-base"><div class="num-wrapper"><img src="assets/num_grid_9.webp"></div></div>
    </div>

    <img src="assets/ui_text_3.webp" class="ui-element countdown-img" id="ui-text-3">
    <img src="assets/ui_text_2.webp" class="ui-element countdown-img" id="ui-text-2">
    <img src="assets/ui_text_1.webp" class="ui-element countdown-img" id="ui-text-1">
    <img src="assets/ui_text_go.webp" class="ui-element countdown-img" id="ui-text-go">

    <img src="assets/ui_text_gameover.webp" class="ui-element end-text" id="ui-text-gameover">
    <img src="assets/ui_text_timeup.webp" class="ui-element end-text" id="ui-text-timeup">

    <div id="ui-home-screen">
        <div id="ui-mask" onclick="this.parentElement.style.display='none'"></div>
        <img src="assets/ui_panel_start.webp" class="ui-element" id="ui-panel-start">
        <img src="assets/character_home.webp" class="ui-element" id="character-home">
        <img src="assets/logo_main.webp" class="ui-element" id="logo-main">
        <img src="assets/btn_coffee.webp" class="ui-element" id="btn-coffee" onclick="alert('Support Button!')">
        <img src="assets/btn_share.webp" class="ui-element" id="btn-share" onclick="alert('Share Button!')">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-start" onclick="startGameProcess()">
        <img src="assets/ui_text_start.webp" class="ui-element" id="ui-text-start">
    </div>

    <div id="ui-input-screen">
        <div style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);"></div>
        <img src="assets/ui_panel_input_name.webp" class="ui-element" id="ui-panel-input">
        <input type="text" id="ui-input-field" placeholder="INPUT NAME" maxlength="8">
        <img src="assets/btn_start.webp" class="ui-element" id="btn-confirm-name" onclick="submitName()">
    </div>

    <div id="ui-result-screen">
        <div id="ui-mask-result" style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7);" onclick="this.parentElement.style.display='none'"></div>
        <img src="assets/logo_rank_title.webp" class="ui-element" id="logo-rank-title">
        <img src="assets/ui_panel_start.webp" class="ui-element" id="res-panel">
        <img src="assets/ui_panel_rank.webp" class="ui-element" id="res-panel-rank"> 
        <div id="rank-content-layer">
            <div id="rank-scroll-view"></div>
        </div>
        <div id="rank-fixed-row">
            <span class="rank-num">6</span>
            <span class="rank-name" id="my-rank-name">YOU</span>
            <span class="rank-flag">ğŸ‡¹ğŸ‡¼</span>
            <div class="rank-score" id="my-rank-score-container"></div>
        </div>
        <img src="assets/btn_coffee.webp" class="ui-element" id="res-btn-coffee">
        <img src="assets/btn_share.webp" class="ui-element" id="res-btn-share">
        <img src="assets/btn_start.webp" class="ui-element" id="res-btn-retry" onclick="startGameProcess()">
        <img src="assets/ui_text_retry.webp" class="ui-element" id="ui-text-retry">
    </div>

    <img src="assets/bg_bar_top.webp" class="ui-element" id="bg-bar-top">
    <img src="assets/bg_bar_bottom.webp" class="ui-element" id="bg-bar-bottom">
</div>

<div id="debug-panel">
    <div class="debug-group">
        <label>ç•«é¢æ¸¬è©¦</label>
        <button class="debug-btn" onclick="showInputScreen()" style="background:#2196f3; border-color:#64b5f6;">âŒ¨ æ¸¬è©¦è¼¸å…¥ä»‹é¢</button>
        <button class="debug-btn" onclick="showResultScreen()" style="background:#f57c00; border-color:#ffb74d;">ğŸ’€ é¡¯ç¤ºçµç®—ä»‹é¢</button>
        <button class="debug-btn" onclick="triggerBearDeath()" style="background:#d32f2f; border-color:#ef5350;">ğŸ» æ¸¬è©¦è®Šèº«</button>
    </div>
    <div class="debug-group">
        <label>éŠæˆ²æµç¨‹</label>
        <button class="debug-btn btn-play" onclick="startGameProcess()">â–¶ æ¸¬è©¦å€’æ•¸</button>
        <button class="debug-btn" onclick="stopGameTimer()">â¹ åœæ­¢è¨ˆæ™‚</button>
    </div>
    <div class="debug-group">
        <label>æ•¸å­—ç¸®æ”¾</label>
        <button class="debug-btn" onclick="testDigits(2)">2ä½</button>
        <button class="debug-btn" onclick="testDigits(5)">5ä½</button>
    </div>
    <div class="debug-group">
        <label>HP / Bar æ¸¬è©¦</label>
        <button class="debug-btn" onclick="testHP(1)">1 HP</button>
        <button class="debug-btn" onclick="testHP(3)">å…¨æ»¿</button>
        <input type="range" id="debug-slider" min="0" max="100" value="100" oninput="testBar(this.value)" style="width:95%; margin-top:5px;">
    </div>
    <button class="debug-btn" style="width:100%; background:#c62828;" onclick="this.parentElement.style.display='none'">éš±è—é¢æ¿</button>
</div>

 
<script type="module">
    // 1. å¼•å…¥ Firebase (åªå¯«é€™ä¸€æ¬¡ï¼Œæ”¾åœ¨æœ€ä¸Šé¢)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, limit, setDoc, doc, serverTimestamp, getCountFromServer } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyAj4XgNOpRKzBlX1cANoDVtHd89HP0Q5HQ",
        authDomain: "pixel-jd-games-hub.firebaseapp.com",
        projectId: "pixel-jd-games-hub",
        storageBucket: "pixel-jd-games-hub.firebasestorage.app",
        messagingSenderId: "672178239988",
        appId: "1:672178239988:web:6a49431cdc1bb9f066e1a1",
        measurementId: "G-FLYGZGG3ZS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const GAME_ID = "bear_flash_tap";

    // --- å…¨åŸŸéŸ³æ•ˆå·¥å…· ---
    let audioCtx = null; 

    function playSnd(f, t, d) {
        if (!audioCtx || audioCtx.state !== 'running') return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = t; 
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.4, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d); 
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    // --- éŠæˆ²è®Šæ•¸ ---
    let gameTimer = null;
    let timeLeft = 1000;
    let comboCount = 0;
    let currentScore = 0;
    let playerName = "YOU"; 
    let lastInputTime = 0;
    const INPUT_COOLDOWN = 60; 
    let lastHitTime = 0;      
    let comboTimerReq = null; 

    // --- è¼”åŠ©å‡½å¼ ---
    function calculateStepScore(combo) {
        const baseScore = 10; 
        let bonus = 0;
        let multiplier = 1;
        if (combo === 0) bonus = 0;
        else if (combo <= 100) bonus = 10 + Math.floor(combo / 10) * 10; 
        else if (combo <= 300) bonus = 220 + Math.floor((combo - 100) / 50) * 20;
        else if (combo <= 600) bonus = 350 + Math.floor((combo - 300) / 100) * 50;
        else if (combo <= 1000) bonus = 600 + Math.floor((combo - 600) / 200) * 100;
        else if (combo <= 2000) bonus = 1000 + Math.floor((combo - 1000) / 250) * 200;
        else if (combo <= 3000) bonus = 2300 + Math.floor((combo - 2000) / 500) * 500;
        else if (combo <= 4000) bonus = 4300 + Math.floor((combo - 3000) / 500) * 1000;
        else if (combo <= 5000) bonus = 8300 + Math.floor((combo - 4000) / 500) * 2000;
        else { bonus = 20600; multiplier = 2; }
        return (baseScore + bonus) * multiplier;
    }

    function getComboWindow(combo) {
        if (combo <= 100) return 1000;
        if (combo <= 300) return 800;
        if (combo <= 600) return 500;
        return 300; 
    }

    function updateComboBar() {
        if (!state.isPlaying || comboCount === 0) {
            document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(0)`;
            return;
        }
        const now = Date.now();
        const windowTime = getComboWindow(comboCount);
        const elapsed = now - lastHitTime;
        let remainRatio = (windowTime - elapsed) / windowTime;
        if (remainRatio <= 0) remainRatio = 0;
        document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(${remainRatio})`;
        if (state.isPlaying && remainRatio > 0) {
            comboTimerReq = requestAnimationFrame(updateComboBar);
        }
    }

    let state = {
        isPlaying: false,
        isPaused: false,
        hearts: 3,
        round: 1,
        currentTarget: 1,
        maxTargetInWave: 9,
        numbersOnGrid: []
    };

    const timerEls = {
        d1: document.getElementById('timer-d1'),
        d2: document.getElementById('timer-d2'),
        d3: document.getElementById('timer-d3'),
        d4: document.getElementById('timer-d4')
    };

    function resizeGame() {
        const container = document.getElementById('game-container');
        const scale = Math.min(window.innerWidth / 720, window.innerHeight / 1280);
        container.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame);
    window.addEventListener('load', () => {
        resizeGame();
        preloadGameAssets();
        document.querySelectorAll('.card-slot').forEach((slot, i) => {
            setupButtonFeedback(slot, true, i); 
        });
        updateScoreDisplay(0); 
        if(window.initLeaderboard) window.initLeaderboard(); 
        
        document.getElementById('ui-input-field').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') window.submitName();
        });
    });

    function preloadGameAssets() {
        const assets = [
            'num_ui_0.webp', 'num_ui_1.webp', 'num_ui_2.webp', 'num_ui_3.webp', 'num_ui_4.webp',
            'num_ui_5.webp', 'num_ui_6.webp', 'num_ui_7.webp', 'num_ui_8.webp', 'num_ui_9.webp', 'num_ui_colon.webp',
            'num_grid_0.webp', 'num_grid_1.webp', 'num_grid_2.webp', 'num_grid_3.webp', 'num_grid_4.webp',
            'num_grid_5.webp', 'num_grid_6.webp', 'num_grid_7.webp', 'num_grid_8.webp', 'num_grid_9.webp',
            'ui_rank_row_normal.webp', 'ui_rank_row_self.webp', 'logo_rank_title.webp',
            'icon_star.webp', 'vfx_thunder.webp', 'ui_text_hit.webp', 'character_bear_devil.webp',
            'ui_panel_input_name.webp', 'ui_text_gameover.webp', 'ui_text_timeup.webp'
        ];
        assets.forEach(name => {
            const img = new Image();
            img.src = 'assets/' + name;
        });
    }

    function resetGameUI() {
        const bear = document.getElementById('ui-character-bear');
        const devil = document.getElementById('ui-character-devil');
        bear.style.display = 'block';
        bear.classList.remove('effect-sink', 'effect-shake');
        devil.style.display = 'none';
        devil.classList.remove('effect-rise');
        if(window.testHP) window.testHP(3); 
        document.getElementById('ui-text-gameover').classList.remove('anim-pop-end');
        document.getElementById('ui-text-timeup').classList.remove('anim-pop-end');
        document.getElementById('ui-home-screen').style.display = 'none';
        document.getElementById('ui-result-screen').style.display = 'none'; 
        document.getElementById('ui-input-screen').style.display = 'none';
        updateScoreDisplay(0);
        updateTimerDisplay(1000);
        document.querySelectorAll('.card-slot').forEach(slot => {
            slot.style.opacity = '1'; 
            const wrapper = slot.querySelector('.num-wrapper');
            if (wrapper) wrapper.innerHTML = ''; 
        });
    }

    // ğŸŒŸ å…¨åŸŸæ›è¼‰ StartGame
    window.startGameProcess = function() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const bgm = document.getElementById('bgm-main');
        if (bgm) { bgm.volume = 0.5; bgm.play().catch(e => console.log("Music blocked:", e)); }

        resetGameUI();
        state = { isPlaying: false, isPaused: false, hearts: 3, round: 1, currentTarget: 1, maxTargetInWave: 9, numbersOnGrid: [] };
        currentScore = 0;
        
        const ids = ['ui-text-3', 'ui-text-2', 'ui-text-1', 'ui-text-go'];
        let delay = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.style.display = 'none'; el.classList.remove('anim-pop');
        });

        ids.forEach((id, index) => {
            setTimeout(() => {
                if(index > 0) document.getElementById(ids[index-1]).style.display = 'none';
                const el = document.getElementById(id);
                el.style.display = 'block'; el.classList.add('anim-pop');
                if (id === 'ui-text-go') {
                    playSnd(880, 'sine', 0.3); 
                    setTimeout(() => { el.style.display = 'none'; startGameLoop(); }, 500);
                } else {
                    playSnd(440, 'sine', 0.1);
                }
            }, delay);
            delay += 800;
        });
    };

    function startGameLoop() {
        state.isPlaying = true;
        timeLeft = 1000;
        comboCount = 0;
        updateScoreDisplay(0);
        updateTimerDisplay(timeLeft);
        spawnWave();
        lastHitTime = Date.now(); 
        if (gameTimer) clearInterval(gameTimer);
        gameTimer = setInterval(() => {
            if (!state.isPlaying || state.isPaused) return;
            timeLeft--;
            if (timeLeft <= 0) { timeLeft = 0; gameOver('time'); }
            updateTimerDisplay(timeLeft);
        }, 10);
    }

    function spawnWave() {
        const startNum = state.round;
        state.currentTarget = startNum;
        state.maxTargetInWave = startNum + 8;
        let nums = [];
        for(let i=0; i<9; i++) nums.push(startNum + i);
        for (let i = nums.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [nums[i], nums[j]] = [nums[j], nums[i]];
        }
        state.numbersOnGrid = nums;
        const slots = document.querySelectorAll('.card-slot');
        slots.forEach((slot, i) => {
            slot.style.display = 'block'; slot.style.opacity = '1';
            setGridNumber(i, nums[i]);
        });
    }

    function handleCardTap(index) {
        if (!state.isPlaying || state.isPaused) return;
        const clickedNum = state.numbersOnGrid[index];
        const slot = document.querySelectorAll('.card-slot')[index];
        if (slot.style.opacity === '0') return;

        if (clickedNum === state.currentTarget) {
            const now = Date.now();
            const windowTime = getComboWindow(comboCount);
            if (comboCount > 0 && (now - lastHitTime) > windowTime) comboCount = 1;
            else comboCount++; 
            lastHitTime = now;

            const scoreThisHit = calculateStepScore(comboCount);
            currentScore += scoreThisHit;
            updateScoreDisplay(currentScore);

            const cx = parseInt(slot.style.left); const cy = parseInt(slot.style.top);
            createStarBurst(cx, cy); createHitEffect(cx, cy, comboCount);
            handleBearHit(); 

            const freq = 800 + (Math.min(comboCount, 200) * 5);
            playSnd(freq, 'sine', 0.1);
            timeLeft += 50; 
            slot.style.opacity = '0';
            state.currentTarget++;
            cancelAnimationFrame(comboTimerReq);
            updateComboBar();

            if (state.currentTarget > state.maxTargetInWave) {
                if (state.round % 5 === 0 && state.hearts < 3) {
                    state.hearts++;
                    if(window.testHP) window.testHP(state.hearts);
                    playSnd(1200, 'sine', 0.3); createHealEffect();
                }
                state.round++;
                setTimeout(spawnWave, 200);
            }
        } else {
            state.hearts--;
            timeLeft -= 100; comboCount = 0; lastHitTime = 0;
            playSnd(150, 'sawtooth', 0.2);
            if(window.testHP) window.testHP(state.hearts);
            slot.classList.add('wrong-flash-card');
            setTimeout(() => slot.classList.remove('wrong-flash-card'), 200);
            if (state.hearts <= 0) gameOver('hearts');
        }
    }

    // ğŸŒŸ ä¿®æ­£ç‰ˆ GameOverï¼šè‡ªå‹•ç™»å…¥ + ID æª¢æŸ¥
    function gameOver(reason) {
        const bgm = document.getElementById('bgm-main');
        if (bgm) { bgm.pause(); bgm.currentTime = 0; }
        state.isPlaying = false;
        if(window.stopGameTimer) window.stopGameTimer();
        if(window.triggerBearDeath) window.triggerBearDeath();

        // æ ¸å¿ƒå‹•ä½œï¼šæª¢æŸ¥æ‰‹æ©Ÿæ˜¯å¦å·²ç¶“æœ‰èº«åˆ†è­‰ (ID)
        const savedId = localStorage.getItem('pixel_jd_player_id');
        const savedName = localStorage.getItem('pixel_jd_player_name');
        
        if (savedId && savedName) {
            // A. è€ç©å®¶ï¼šç›´æ¥ä¸Šå‚³ä¸¦çœ‹æ’è¡Œ
            playerName = savedName; 
            if (window.uploadScore) window.uploadScore(playerName, currentScore);

            setTimeout(() => {
                if(window.showResultScreen) window.showResultScreen();
                if(window.initLeaderboard) window.initLeaderboard();
            }, 2800);
        } else {
            // B. æ–°ç©å®¶ï¼šè·³å‡ºè¼¸å…¥åå­—ç•«é¢
            setTimeout(() => {
                if(window.showInputScreen) window.showInputScreen();
            }, 2800);
        }

        setTimeout(() => {
            const elId = (reason === 'time') ? 'ui-text-timeup' : 'ui-text-gameover';
            document.getElementById(elId).classList.add('anim-pop-end');
        }, 800);
    }

    function setGridNumber(index, number) {
        const slots = document.querySelectorAll('.card-slot');
        if (!slots[index]) return;
        const wrapper = slots[index].querySelector('.num-wrapper');
        const numStr = number.toString();
        wrapper.innerHTML = '';
        for (let char of numStr) {
            const img = document.createElement('img');
            img.src = `assets/num_grid_${char}.webp`;
            wrapper.appendChild(img);
        }
        let scaleValue = 1.0;
        if (numStr.length >= 4) scaleValue = 0.6; 
        wrapper.style.transform = `translate(-50%, -50%) scale(${scaleValue})`;
    }

    function createStarBurst(x, y) {
        const container = document.getElementById('game-container');
        for (let i = 0; i < 5; i++) {
            const star = document.createElement('img');
            star.src = 'assets/icon_star.webp'; star.className = 'particle-star';
            const size = Math.random() * 40 + 60; 
            star.style.width = `${size}px`; star.style.height = `${size}px`;
            star.style.left = `${x}px`; star.style.top = `${y}px`;
            star.style.transform = `translate(-50%, -50%) scale(0.5)`;
            const angle = Math.random() * Math.PI * 2; 
            const velocity = Math.random() * 150 + 100; 
            const tx = Math.cos(angle) * velocity; const ty = Math.sin(angle) * velocity;
            const rot = Math.random() * 720; 
            container.appendChild(star);
            requestAnimationFrame(() => {
                star.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(0) rotate(${rot}deg)`;
                star.style.opacity = '0';
            });
            setTimeout(() => star.remove(), 800);
        }
    }

    function createHealEffect() {
        const container = document.getElementById('game-container');
        const heart = document.createElement('img');
        heart.src = 'assets/icon_heart.webp';
        heart.style.position = 'absolute'; heart.style.width = '60px'; heart.style.height = 'auto'; heart.style.zIndex = '999';
        heart.style.left = '360px'; heart.style.top = '460px'; 
        heart.style.transform = 'translate(-50%, -50%) scale(0.5)';
        heart.style.transition = 'transform 1s ease-out, opacity 1s ease-out, top 1s ease-out';
        container.appendChild(heart);
        requestAnimationFrame(() => {
            heart.style.top = '260px'; heart.style.transform = 'translate(-50%, -50%) scale(1.5)'; heart.style.opacity = '0';
        });
        setTimeout(() => heart.remove(), 1000);
    }

    function createHitEffect(x, y, comboVal) {
        const container = document.getElementById('game-container');
        const wrapper = document.createElement('div');
        wrapper.className = 'hit-effect-wrapper';
        wrapper.style.left = `${x}px`; wrapper.style.top = `${y - 50}px`; 
        const valStr = comboVal.toString();
        for (let char of valStr) {
            const digit = document.createElement('img');
            digit.src = `assets/num_ui_${char}.webp`; digit.className = 'hit-num-digit';
            wrapper.appendChild(digit);
        }
        const hitImg = document.createElement('img');
        hitImg.src = 'assets/ui_text_hit.webp'; hitImg.className = 'hit-text-img';
        wrapper.appendChild(hitImg);
        container.appendChild(wrapper);
        setTimeout(() => wrapper.remove(), 1500); 
    }

    function updateScoreDisplay(newScore) {
        const scoreContainer = document.getElementById('ui-game-score');
        scoreContainer.innerHTML = ''; 
        const scoreStr = newScore.toString(); 
        for (let char of scoreStr) {
            const img = document.createElement('img');
            img.src = `assets/num_grid_${char}.webp`; img.className = 'score-digit-img';
            scoreContainer.appendChild(img);
        }
    }

    function getScoreHtml(score) {
        const str = score.toString(); 
        let html = '';
        for(let char of str) html += `<img src="assets/num_grid_${char}.webp" class="rank-score-digit">`;
        return html;
    }

    function handleBearHit() {
        const bearNormal = document.getElementById('ui-character-bear');
        const bearDevil = document.getElementById('ui-character-devil');
        const activeBear = (bearDevil.style.display !== 'none' && bearDevil.classList.contains('effect-rise')) ? bearDevil : bearNormal;
        activeBear.classList.remove('effect-shake');
        void activeBear.offsetWidth; 
        activeBear.classList.add('effect-shake');
        setTimeout(() => activeBear.classList.remove('effect-shake'), 200);
    }

    function setupButtonFeedback(element, isCard = false, index = -1) {
        if (!element) return;
        const pressClass = isCard ? 'pressed' : 'btn-pressed';
        element.addEventListener('pointerdown', (e) => {
            const now = Date.now();
            if (now - lastInputTime < INPUT_COOLDOWN) return; 
            lastInputTime = now;
            element.classList.add(pressClass);
            element.setPointerCapture(e.pointerId);
            if (isCard && state.isPlaying) handleCardTap(index);
        });
        const release = () => { element.classList.remove(pressClass); };
        element.addEventListener('pointerup', release);
        element.addEventListener('pointerleave', release);
        element.addEventListener('pointercancel', release);
    }
    
    // Bind buttons
    setupButtonFeedback(document.getElementById('btn-start'));
    setupButtonFeedback(document.getElementById('btn-coffee'));
    setupButtonFeedback(document.getElementById('btn-share'));
    setupButtonFeedback(document.getElementById('res-btn-retry'));
    setupButtonFeedback(document.getElementById('res-btn-coffee'));
    setupButtonFeedback(document.getElementById('res-btn-share'));
    setupButtonFeedback(document.getElementById('btn-confirm-name'));

    async function doShare() {
        try {
            const rounds = (typeof state !== 'undefined') ? state.round : 0;
            const score = (typeof currentScore !== 'undefined') ? currentScore : 0;
            const shareText = `ğŸ»ã€ç†Šç†Šé–ƒé›»æ‰‹ã€‘æŒ‘æˆ°æˆåŠŸï¼\næˆ‘æ‹¿åˆ°äº† ${rounds} è¼ªï¼Œç¸½è¨ˆ â˜…${score} åˆ†ï¼\nğŸ‘‰ ${window.location.href}`;
            const isLine = /Line/i.test(navigator.userAgent);
            if (navigator.share && !isLine) await navigator.share({ title: 'ç†Šç†Šé–ƒé›»æ‰‹', text: shareText, url: window.location.href });
            else window.open(`https://line.me/R/share?text=${encodeURIComponent(shareText)}`, '_blank');
        } catch (err) { console.log("Share canceled"); }
    }
    const shareBtn1 = document.getElementById('btn-share');
    const shareBtn2 = document.getElementById('res-btn-share');
    if (shareBtn1) shareBtn1.onclick = (e) => { e.preventDefault(); doShare(); };
    if (shareBtn2) shareBtn2.onclick = (e) => { e.preventDefault(); doShare(); };

    // --- é—œéµå…¨åŸŸå‡½å¼ (è§£æ±º ReferenceError) ---
    
    window.showInputScreen = function() {
        document.getElementById('ui-home-screen').style.display = 'none';
        document.getElementById('ui-result-screen').style.display = 'none';
        document.getElementById('ui-input-screen').style.display = 'block';
        document.getElementById('ui-input-field').focus();
    };

    window.showResultScreen = function() {
        document.getElementById('ui-result-screen').style.display = 'block';
        const nameEl = document.getElementById('my-rank-name');
        if(nameEl) nameEl.textContent = playerName;
        const myScoreContainer = document.getElementById('my-rank-score-container');
        if(myScoreContainer) myScoreContainer.innerHTML = getScoreHtml(currentScore);
    };

    window.triggerBearDeath = function() {
        const bearNormal = document.getElementById('ui-character-bear');
        const bearDevil = document.getElementById('ui-character-devil');
        bearNormal.classList.add('effect-sink');
        setTimeout(() => {
            bearNormal.style.display = 'none'; 
            bearDevil.style.display = 'block'; 
            bearDevil.classList.add('effect-rise');
        }, 1000); 
    };

    window.stopGameTimer = function() {
        if (gameTimer) clearInterval(gameTimer);
    };

    window.testDigits = function(d) {
        const val = Math.pow(10, d) - 1;
        document.querySelectorAll('.card-slot').forEach((_, i) => setGridNumber(i, val));
    };

    window.testHP = function(hp) {
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`ui-heart-${i}`).style.opacity = i <= hp ? "1" : "0.2";
        }
    };

    window.testBar = function(val) {
        document.getElementById('ui-combo-bar-fill').style.transform = `translate(-50%, -50%) scaleX(${val/100})`;
    };

    function updateTimerDisplay(totalUnits) {
        const container = document.getElementById('ui-timer-container');
        if (totalUnits <= 300) container.classList.add('timer-danger', 'timer-pulse');
        else container.classList.remove('timer-danger', 'timer-pulse');
        const seconds = Math.floor(totalUnits / 100);
        const millis = totalUnits % 100;
        const sStr = seconds.toString().padStart(2, '0');
        const mStr = millis.toString().padStart(2, '0');
        if (timerEls.d1.src.indexOf(`num_ui_${sStr[0]}.webp`) === -1) timerEls.d1.src = `assets/num_ui_${sStr[0]}.webp`;
        if (timerEls.d2.src.indexOf(`num_ui_${sStr[1]}.webp`) === -1) timerEls.d2.src = `assets/num_ui_${sStr[1]}.webp`;
        if (timerEls.d3.src.indexOf(`num_ui_${mStr[0]}.webp`) === -1) timerEls.d3.src = `assets/num_ui_${mStr[0]}.webp`;
        if (timerEls.d4.src.indexOf(`num_ui_${mStr[1]}.webp`) === -1) timerEls.d4.src = `assets/num_ui_${mStr[1]}.webp`;
    }
    updateTimerDisplay(1000);

    // --- Firebase æ ¸å¿ƒé‚è¼¯ (é˜²æ­¢æ’åã€ä¸€äººä¸€å‘ã€çœŸå¯¦æ’å) ---

    // 1. ä¸Šå‚³åˆ†æ•¸ (ID é–å®šç‰ˆ)
    window.uploadScore = async function(playerName, score) {
        if (!playerName) playerName = "åŒ¿åç©å®¶";
        const playerId = localStorage.getItem('pixel_jd_player_id');
        if (!playerId) return; 

        try {
            const docRef = doc(db, `leaderboard_${GAME_ID}`, playerId);
            const q = query(collection(db, `leaderboard_${GAME_ID}`), where("__name__", "==", playerId));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const existingData = querySnapshot.docs[0].data();
                if (score > existingData.score) {
                    await setDoc(docRef, { name: playerName, score: score, timestamp: serverTimestamp() }, { merge: true });
                    console.log("ğŸ† ç ´ç´€éŒ„ï¼å€‹äººæœ€é«˜åˆ†å·²æ›´æ–°");
                }
            } else {
                await setDoc(docRef, { name: playerName, score: score, timestamp: serverTimestamp() });
                console.log("âœ… æ–°èº«åˆ†èªè­‰æˆåŠŸï¼Œæˆç¸¾ä¸Šå‚³æˆåŠŸ");
            }
        } catch (e) { console.error("Firebase ä¸Šå‚³å¤±æ•—:", e); }
    };

    // 2. æäº¤åå­— (é˜²æ­¢æ’åæª¢æŸ¥ + ä¿®æ­£ä¸Šå‚³é †åº)
    window.submitName = async function() {
        const inputField = document.getElementById('ui-input-field');
        const inputVal = inputField.value.trim();
        if (!inputVal) { alert("è«‹è¼¸å…¥æš±ç¨±å–”ï¼"); return; }

        const checkName = inputVal.substring(0, 8); 
        const btn = document.getElementById('btn-confirm-name');
        if(btn) { btn.style.opacity = "0.5"; btn.style.pointerEvents = "none"; }

        try {
            const leaderRef = collection(db, `leaderboard_${GAME_ID}`);
            const q = query(leaderRef, where("name", "==", checkName));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                alert(`ã€Œ${checkName}ã€å·²ç¶“æœ‰äººä½¿ç”¨äº†ï¼Œè«‹æ›ä¸€å€‹åå­—ï¼`);
                inputField.value = ""; 
                if(btn) { btn.style.opacity = "1"; btn.style.pointerEvents = "auto"; }
                return; 
            }

            // é€šéæª¢æŸ¥ï¼Œç”¢ç”Ÿ ID ä¸¦å„²å­˜
            playerName = checkName;
            const playerId = 'id_' + Math.random().toString(36).substr(2, 9) + Date.now();
            localStorage.setItem('pixel_jd_player_name', playerName);
            localStorage.setItem('pixel_jd_player_id', playerId);

            document.getElementById('ui-input-screen').style.display = 'none';
            if(btn) { btn.style.opacity = "1"; btn.style.pointerEvents = "auto"; }

            // ğŸŒŸ æ ¸å¿ƒä¿®æ”¹å€ï¼šé †åºèª¿æ› + ç­‰å¾…æ©Ÿåˆ¶ ğŸŒŸ
            
            // 1. å…ˆé¡¯ç¤ºçµç®—æ¡† (è®“ç©å®¶çŸ¥é“æœ‰åœ¨å‹•)
            if (window.showResultScreen) window.showResultScreen();

            // 2. ã€é—œéµã€‘å…ˆä¸Šå‚³åˆ†æ•¸ï¼Œä¸¦ä¸”ã€Œç­‰å¾… (await)ã€å®ƒå®Œæˆï¼
            if (window.uploadScore) {
                await window.uploadScore(playerName, currentScore);
            }

            // 3. ç¢ºå®šä¸Šå‚³å®Œæˆå¾Œï¼Œæ‰å»æŠ“æ’è¡Œæ¦œï¼Œé€™æ¨£ä¸€å®šæŠ“å¾—åˆ°æœ€æ–°è³‡æ–™
            if (window.initLeaderboard) {
                await window.initLeaderboard();
            }

        } catch (e) {
            console.error("æª¢æŸ¥åå­—å¤±æ•—:", e);
            alert("é€£ç·šæª¢æŸ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            if(btn) { btn.style.opacity = "1"; btn.style.pointerEvents = "auto"; }
        }
    };

    // 3. è®€å–æ’è¡Œæ¦œ + çœŸå¯¦æ’åè¨ˆç®—
    window.initLeaderboard = async function() {
        const list = document.getElementById('rank-scroll-view');
        if(!list) return;
        list.innerHTML = '<div style="color:white; text-align:center; padding-top:50px; font-size:24px; font-family:sans-serif;">LOADING RANK...</div>';

        try {
            const leaderRef = collection(db, `leaderboard_${GAME_ID}`);
            
            // æŠ“å‰ 10 å
            const qTop = query(leaderRef, orderBy("score", "desc"), limit(10));
            const snapshot = await getDocs(qTop);
            const realData = snapshot.docs.map(doc => doc.data());
            
            list.innerHTML = ''; 
            if (realData.length === 0) {
                list.innerHTML = '<div style="color:gray; text-align:center; padding-top:50px; font-family:sans-serif;">ç›®å‰å°šç„¡æ’åç´€éŒ„</div>';
            } else {
                realData.forEach((data, index) => {
                    const row = document.createElement('div');
                    row.className = 'rank-row';
                    row.innerHTML = `
                        <span class="rank-num">${index + 1}</span>
                        <span class="rank-name">${(data.name || "Unknown").substring(0, 8)}</span>
                        <span class="rank-flag">ğŸ‡¹ğŸ‡¼</span>
                        <div class="rank-score">${getScoreHtml(data.score || 0)}</div>
                    `;
                    list.appendChild(row);
                });
            }

            // è¨ˆç®—çœŸå¯¦æ’å
            const myId = localStorage.getItem('pixel_jd_player_id');
            const myFixedRow = document.getElementById('rank-fixed-row');
            
            if (myId && myFixedRow) {
                const myDocSnap = await getDocs(query(leaderRef, where("__name__", "==", myId)));
                if (!myDocSnap.empty) {
                    const myData = myDocSnap.docs[0].data();
                    const myHighScore = myData.score;
                    
                    const myNameEl = document.getElementById('my-rank-name');
                    const myScoreEl = document.getElementById('my-rank-score-container');
                    if (myNameEl) myNameEl.textContent = myData.name;
                    if (myScoreEl) myScoreEl.innerHTML = getScoreHtml(myHighScore);

                    // è¨ˆç®—æ’å (æ¯”æˆ‘é«˜çš„äººæ•¸ + 1)
                    const qRank = query(leaderRef, where("score", ">", myHighScore));
                    const snapshotRank = await getCountFromServer(qRank);
                    const myRealRank = snapshotRank.data().count + 1;

                    const rankNumEl = myFixedRow.querySelector('.rank-num');
                    if (rankNumEl) {
                        rankNumEl.textContent = myRealRank;
                        rankNumEl.style.fontSize = myRealRank > 999 ? "24px" : "40px";
                    }
                }
            } else if (myFixedRow) {
                const rankNumEl = myFixedRow.querySelector('.rank-num');
                if (rankNumEl) rankNumEl.textContent = "-";
            }
        } catch (error) {
            console.error("æ’è¡Œæ¦œè®€å–å¤±æ•—:", error);
            list.innerHTML = '<div style="color:red; text-align:center; padding-top:50px;">é€£ç·šå¤±æ•—</div>';
        }
    };

    // èˆŠç‰ˆå…¼å®¹ (å¦‚æœä½ å…¶ä»–åœ°æ–¹é‚„æœ‰å‘¼å«é€™å€‹)
    window.getLeaderboard = async function() {
        const leaderRef = collection(db, `leaderboard_${GAME_ID}`);
        const q = query(leaderRef, orderBy("score", "desc"), limit(10));
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => doc.data());
    };
</script>

</body>
</html>